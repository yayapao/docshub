---
title: Callback
authors: y
slug: callback
tags: [callback hell]
---

# Medium



## Callbacks In JavaScript


> **Callbacks in JavaScript is everywhere!**

æœ¬æ–‡è¦ç‚¹:

- ä»€ä¹ˆæ˜¯å›è°ƒ
- â€œå›è°ƒåœ°ç‹±â€
- å¦‚ä½•ä¼˜é›…åœ°è§£å†³å›è°ƒåœ°ç‹±



### Callbacks

å¦‚æœè¯´ â€œæœ‰äººçš„åœ°æ–¹å°±æœ‰æ±Ÿæ¹–â€, é‚£ä¹ˆåœ¨ JavaScript ä¸­, â€œæœ‰äº¤äº’çš„åœ°æ–¹å°±æœ‰å›è°ƒâ€

åœ¨æ—¥å¸¸å¼€å‘ä¸­, æœ€å¸¸è§çš„é¡µé¢åŠ è½½å®Œæ¯•çš„ `onload` äº‹ä»¶, é€šç”¨çš„é¼ æ ‡ç‚¹å‡»äº‹ä»¶, éƒ½ç¦»ä¸å¼€å›è°ƒçš„å½±å­. 

æˆ‘è¿™æ ·æ¥å®šä¹‰å›è°ƒ, **å›è°ƒæ˜¯ç”¨æ¥å¤„ç†äº¤äº’åäº‹ä»¶çš„æ‰§è¡Œä»£ç å—, å‡½æ•°å¯ä»¥ç†è§£æˆä¸€ç§äº¤äº’çš„æŠ½è±¡**

æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£:

è¿™é‡Œ, æˆ‘å¸Œæœ›èƒ½å¤Ÿå®ç°å¼‚æ­¥åŠ è½½è„šæœ¬

```javascript
function loadScript(src) {
    var script = document.createElement('script');
    script.src = src;
    document.head.appendChild(script);
}
```



æˆ‘ä»¬å‡å®š`hello.js` å†…æœ‰ `sayHello()` çš„ä¸€ä¸ªæ–¹æ³•, æˆ‘ä»¬éœ€è¦æ‰§è¡Œè¯¥æ–¹æ³•:

```javascript
// load and run the script
loadScript('hello.js')
// no such function
sayHello()
```



å¦‚æœæŒ‰ç…§ä¸Šé¢çš„æ–¹å¼, å¾ˆæ˜æ˜¾ä¼šæ‰§è¡Œå¤±è´¥,å› ä¸º `sayHello()` å¹¶ä¸ä¼šç­‰åˆ° `hello.js` åŠ è½½å¹¶æ‰§è¡Œå®Œæ¯•åæ‰ä¼šæ‰§è¡Œ

å¦‚æœå¸Œæœ›å®ƒèƒ½å¤Ÿæ­£ç¡®å‘ç”Ÿ,æ­£ç¡®çš„åšæ³•æ˜¯åœ¨è„šæœ¬å‡†å¤‡å°±ç»ªä¹‹åå†æ‰§è¡Œå…¶æ–¹æ³•,ä¿®æ”¹è„šæœ¬ä¹‹åå¦‚ä¸‹:

```javascript
function loadScript(src, callback) {
    var script = document.createElement('script');
    script.src = src;
    script.onload = function () { return callback && callback(script); };
    document.head.appendChild(script);
}

// ok, it works
loadScript('hello.js', () => { sayHello() })
```



ä¸Šé¢å°±æ˜¯é’ˆå¯¹å›è°ƒæœ€é€šç”¨çš„è§£é‡Š, `loadScript()` å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªé«˜åº¦æŠ½è±¡çš„äº¤äº’, å¯ä»¥ç»†å“ä¸€ä¸‹è¿™



### Callback Hell

â€œå›è°ƒåœ°ç‹±â€åœ¨ NodeJs å†…å‘æ‰¬å…‰å¤§, å…¶å®åœ¨ JavaScript å†…ä¹Ÿä¸æ–°é²œ, ä¸€å¥è¯æ¥è§£é‡Šå°±æ˜¯ `callback in callback`(åµŒå¥—!)

çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­:

```javascript
// æˆ‘ä»¬éœ€è¦æŒ‰ç…§é¡ºåºåŠ è½½è‹¥å¹²ä¸ªè„šæœ¬, æœ€åæ‰§è¡Œä¸€ä¸ªç‰¹å®šçš„æ–¹æ³•
loadScript('hello.js', () => {
  loadScript('world.js', () => {
    laodScript('byebye.js', () => {
      // loop and loop, callback and callback
      sayHello()
    })
  })
})
```



ğŸ™‰ä¸€äº›ç¢ç¢å¿µ: è¿™æ ·å­çš„ä»£ç , æ²¡æœ‰ä¸æ¯«çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§, ä¹Ÿä¸å¤Ÿä¼˜é›…, â€œjust shit codeâ€. å¤§å®¶åœ¨å¼€å‘è¿‡ç¨‹ä¸­åº”è¯¥å°½é‡é¿å…ç”Ÿäº§ç±»ä¼¼ä»£ç , æœ€æœ€æœ€ç®€å•çš„, èµ·ç å¯ä»¥é€šè¿‡å‘½åå‡½æ•°æ¥å°è£…æ¯ä¸€æ¬¡å›è°ƒçš„å†…å®¹!



### Promise

é‚£ä¹ˆå¦‚ä½•ä¼˜é›…åœ°è§£å†³å›è°ƒåœ°ç‹±å‘¢, ç‰ˆæœ¬ç­”æ¡ˆ `Promise`

**Promise** åœ¨ ES6 å†…è¢«å¼•ç”¨ç”¨æ¥å¤„ç†å¼‚æ­¥æ“ä½œ, é¡ºå¸¦è§£å†³äº†å›è°ƒåœ°ç‹±, è¿™é‡Œä¸å†å¯¹å…¶è¿›è¡Œèµ˜è¿°

åˆ©ç”¨ **Promise**, å¯¹ `loadScript()` è¿›è¡Œè¿›ä¸€æ­¥çš„æ”¹å†™, å¹¶ä¸”ä»¥ Promise çš„æ–¹å¼æ¥å®ç°ä¸Šé¢çš„è„šæœ¬è°ƒç”¨

```javascript
function loadScript(src) {
    return new Promise(function (resolve, reject) {
        var script = document.createElement('script');
        script.src = src;
        script.onload = function () { return resolve(script); };
        script.onerror = function () { return reject(new Error(src + " fail to load")); };
        document.head.appendChild(script);
    });
}

loadScript('hello.js')
  .then((hello) => { return loadScript('world.js') })
	.then((world) => { return loadScript('byebye.js') })
	.then((byebye) => { sayHello() })
	.catch((error) => { console.error(error.message) })
```



æ—¢ç„¶å·²ç»æåˆ°äº† `Promise`, æˆ‘ä»¬ä¸å¦¨å°†çŸ¥è¯†ç‚¹å†å»¶ä¼¸ä¸€äº›, äº†è§£ä¸‹ **async and await**

**await** æ˜¯ Promise çš„è¯­æ³•ç³–, é€šè¿‡é…åˆ **async** æ¥ä½¿ç”¨, çœ‹çœ‹å¦‚æœç”¨è¿™â€œä¸¤å…„å¼Ÿâ€æ¥æ”¹å†™ä¸Šé¢çš„ä¾‹å­

```javascript
(async () => {
  await loadScript('hello.js')
  await loadScript('world.js')
  await loadScript('byebye.js')
  sayHello()
})()
```

`async/await` æ‹¥æœ‰æ›´åŠ ç®€æ´çš„è¯­æ³•, åŒæ—¶è®©æ•´ä¸ªä»£ç çœ‹èµ·æ¥æ›´åŠ è‡ªç„¶çš„å‘ç”Ÿ!
