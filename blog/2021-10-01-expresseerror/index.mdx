---
title: Error Catcher In Express
authors: y
slug: expresserror
tags: [runtime, error]
---

èƒŒæ™¯ï¼šåœ¨è¿›è¡Œè°ƒç”¨é“¾æ•°æ®é‡‡é›†æ—¶ï¼Œå‘ç° express æ¡†æ¶ä¸‹ï¼Œres å¯¹è±¡å†…åªæœ‰ statusMessage å’Œ statusCode èƒ½å¤Ÿè·å–åˆ°é”™è¯¯ç›¸å…³çš„ä¿¡æ¯ï¼Œæ— æ³•ä» res å¯¹è±¡å†…è·å–åˆ°é”™è¯¯å †æ ˆä¿¡æ¯

{/* truncate */}

å‚è€ƒ [express error handling](https://expressjs.com/zh-cn/guide/error-handling.html) æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œå½“å‘ç”Ÿä¸€ä¸ªé”™è¯¯æ—¶ï¼Œä¼šå°†ä»¥ä¸‹ä¿¡æ¯æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ç»‘å®šåˆ° res å¯¹è±¡ä¸Šï¼š

1. `res.statusCode` ä¼šæ ¹æ® `err.status || err.statusCode` è¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœå€¼ä¸æ˜¯ 400 - 500 èŒƒå›´å†…ï¼Œç»Ÿä¸€è®¾ç½®ä¸º 500ï¼›
2. `res.statusMessage` æ ¹æ® `statusCode` è¿›è¡Œèµ‹å€¼ï¼›
3. åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œè¿”å› body ä¸º statusCode å’Œ statusMessageï¼Œæˆ–è€…ä¸º err.stack

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å‘ç° express ä¸€å®šè¦å°†é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ”¾åœ¨æœ«å°¾ï¼Œä¸”éœ€è¦ä¼ å¤šä¸€ä¸ª `err` å‚æ•°

**Case1: error middleware åœ¨ route ä¹‹å‰ï¼Œä¼šç›´æ¥è¿”å›é”™è¯¯å †æ ˆï¼Œè€Œä¸æ˜¯ `Something failed!`**

> "å¦‚æœå°†ä»»ä½•é¡¹ä¼ é€’åˆ° next() å‡½æ•°ï¼ˆé™¤äº†å­—ç¬¦ä¸² 'route'ï¼‰ï¼Œé‚£ä¹ˆ Express ä¼šå°†å½“å‰è¯·æ±‚è§†ä¸ºå¤„äºé”™è¯¯çŠ¶æ€ï¼Œå¹¶è·³è¿‡æ‰€æœ‰å‰©ä½™çš„éé”™è¯¯å¤„ç†è·¯ç”±å’Œä¸­é—´ä»¶å‡½æ•°"

```javascript
function md1(req, res, next) {
  console.log('md1')
  next()
}
app.use(md1)
app.use((err, req, res, next) => {
  console.log('Enter in Error!')
  res.status(500).send({ error: 'Something failed!' })
})
app.get('/md', (req, res) => {
  throw new Error('1')
})

// console.log
// md1
// ===> 500 return err.stack
```

**Case2: error middleware åœ¨æœ€åï¼Œè¿”å›ç»“æœ `Something failed!`**

```javascript
function md1(req, res, next) {
  console.log('md1')
  next()
}
app.use(md1)
app.get('/md', (req, res) => {
  throw new Error('1')
})
app.use((err, req, res, next) => {
  console.log('Enter in Error!')
  res.status(500).send({ error: 'Something failed!' })
})

// console.log
// md1
// Enter in Error!
// ===> 500 return Something failed!
```

å°å°çš„ ğŸ‘€ï¼Œå¤§å¤§çš„å›°æƒ‘ï¼š

1. ä¸ºä»€ä¹ˆéœ€è¦å°†é”™è¯¯å¤„ç†æ”¾åœ¨æœ€åé¢ï¼Ÿ
2. `app.use` å¦‚ä½•å¤„ç† error handle? middleware å¦‚ä½•æ ¹æ®ä¼ å‚ä¸ªæ•°æ¥å‘èµ·ä¸åŒçš„å¤„ç†ï¼Ÿ
3. `next(err)` å¦‚ä½•ä¼ é€’é”™è¯¯ä¿¡æ¯åˆ°ä¸‹ä¸€ä¸ª middleware?
4. express å¦‚ä½•è®¾ç½® res.statusCodeã€res.statusMessage ä»¥åŠ err.stack ?

### æºç è§£è¯»

> å½“é‡åˆ°é—®é¢˜æ—¶ï¼Œä¸å¦¨ä»æºç æ‰¾æ‰¾æ€è·¯ ---Y

é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹çœ‹åœ¨åˆå§‹åŒ–ä¸€ä¸ª express å®ä¾‹æ—¶ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

```javascript
// express.js
/**
 * ç”¨æ¥åˆ›å»º express åº”ç”¨ï¼Œå½“æ‰§è¡Œ express() å›è°ƒç”¨ app()ï¼Œè¿”å› app å®ä¾‹åŠå…¶åŒ…å«å±æ€§
 * 1. è¿™é‡Œ req\res ä¸ºé€šè¿‡ Object.defineProperty() å®šä¹‰çš„å¯¹è±¡ï¼Œå¹¶åœ¨ä¸Šä¸‹æ–‡å†…è¿›è¡Œå¼•ç”¨
 * 2. next æŒ‡å‘å›è°ƒå‡½æ•°çš„å¼•ç”¨
 */
function createApplication() {
  var app = function (req, res, next) {
    app.handle(req, res, next)
  }

  mixin(app, EventEmitter.prototype, false)
  mixin(app, proto, false)

  // æš´éœ² request åŸå‹å¯¹è±¡
  app.request = Object.create(req, {
    app: { configurable: true, enumerable: true, writable: true, value: app },
  })

  // æš´éœ² response åŸå‹å¯¹è±¡
  app.response = Object.create(res, {
    app: { configurable: true, enumerable: true, writable: true, value: app },
  })

  // init() å®šä¹‰ app å†… settings å†…å®¹
  app.init()
  return app
}

// application.js
/**
 * å°† req, res åˆ†å‘åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œå¹¶å¼€å§‹ç®¡é“å¤„ç†
 */
app.handle = function handle(req, res, callback) {
  var router = this._router

  /**
   * å¦‚æœæ²¡æœ‰ä¼ é€’ callback, åˆ™é»˜è®¤ä¸ºæœ€åä¸€æ­¥ï¼Œå°†å…¶å¤„ç†ä¸º finalhandler
   * Node.js function to invoke as the final step to respond to HTTP requestï¼Œå‚è€ƒ https://www.npmjs.com/package/finalhandler
   * **åœ¨ callback ä¸ºç©ºæƒ…å†µä¸‹ï¼Œé€šè¿‡è°ƒç”¨ finalhandler è®¾ç½® res.statusCodeã€res.statusMessage ä»¥åŠ err.stack**
   */
  var done =
    callback ||
    finalhandler(req, res, {
      env: this.get('env'),
      onerror: logerror.bind(this),
    })

  // å¦‚æœå½“å‰ router ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œ
  if (!router) {
    debug('no routes defined on app')
    done()
    return
  }

  router.handle(req, res, done)
}
```

ç´§æ¥ç€ï¼Œæˆ‘ä»¬é€šè¿‡ä¼šè°ƒç”¨ `app.use()` æ¥æŒ‚è½½ä¸­é—´ä»¶å›è°ƒï¼š

```javascript
// application.js

app.use = function use(fn) {
  var offset = 0
  var path = '/'

  // é»˜è®¤ path ä¸º /
  // è¿™é‡Œå…¼å®¹å¤„ç†ä¼ å…¥å¤šä¸ª middleware çš„æƒ…å†µ
  if (typeof fn !== 'function') {
    var arg = fn

    while (Array.isArray(arg) && arg.length !== 0) {
      arg = arg[0]
    }

    // å¤„ç†ç¬¬ä¸€ä¸ªå‚æ•°ä¸º path çš„æƒ…å†µ
    if (typeof arg !== 'function') {
      offset = 1
      path = fn
    }
  }

  // è·å¾—ä¸­é—´ä»¶é›†åˆ
  var fns = flatten(slice.call(arguments, offset))

  if (fns.length === 0) {
    throw new TypeError('app.use() requires a middleware function')
  }

  /**
   * lazyrouter() ç”¨æ¥è¿”å› Router å¯¹è±¡ï¼Œå¦‚æœ router å¯¹è±¡ä¸ºç©ºï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ—¶åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š
   * 1. query() å†…è§£æ url å¹¶å°† query å‚æ•°èµ‹å€¼ç»™ req.query
   * 2. å°† res, req, next ç»‘å®šåˆ° app å®ä¾‹ä¸Š
   */
  this.lazyrouter()
  var router = this._router

  // ä¹‹åï¼Œéå†å‚æ•°ï¼Œå°†å…¶ç”Ÿæˆ layer å¹¶æ”¾åˆ°åˆ°æŒ‡å®šè·¯å¾„çš„  router å¯¹è±¡çš„ stack å±æ€§å†…
  fns.forEach(function (fn) {
    // non-express app
    if (!fn || !fn.handle || !fn.set) {
      return router.use(path, fn)
    }

    debug('.use app under %s', path)
    fn.mountpath = path
    fn.parent = this

    router.use(path, function mounted_app(req, res, next) {
      var orig = req.app
      fn.handle(req, res, function (err) {
        setPrototypeOf(req, orig.request)
        setPrototypeOf(res, orig.response)
        next(err)
      })
    })

    // mounted an app
    fn.emit('mount', this)
  }, this)

  return this
}
```

åœ¨ `router.use()` å†…ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå°†ä¼ å…¥çš„æ‰€æœ‰å›è°ƒæŒ‰ç…§é¡ºåºç”Ÿæˆ layer å¯¹è±¡ï¼Œå¹¶æ”¾å…¥æ‰§è¡Œå †æ ˆï¼Œæœ€åå°†å †æ ˆæŒ‚è½½åˆ° router å¯¹è±¡ä¸Š

```javascript
// router/index.js

proto.use = function use(fn) {
  var offset = 0
  var path = '/'

  if (typeof fn !== 'function') {
    var arg = fn

    while (Array.isArray(arg) && arg.length !== 0) {
      arg = arg[0]
    }

    if (typeof arg !== 'function') {
      offset = 1
      path = fn
    }
  }

  var callbacks = flatten(slice.call(arguments, offset))

  if (callbacks.length === 0) {
    throw new TypeError('Router.use() requires a middleware function')
  }

  for (var i = 0; i < callbacks.length; i++) {
    var fn = callbacks[i]

    if (typeof fn !== 'function') {
      throw new TypeError(
        'Router.use() requires a middleware function but got a ' + gettype(fn)
      )
    }

    // add the middleware
    debug('use %o %s', path, fn.name || '<anonymous>')

    var layer = new Layer(
      path,
      {
        sensitive: this.caseSensitive,
        strict: false,
        end: false,
      },
      fn
    )

    layer.route = undefined

    this.stack.push(layer)
  }

  return this
}

// router/layer.js
// æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ Layer å†…ï¼Œé€šè¿‡ä¸€äº›å±æ€§æ¥æ ‡è¯† middlewareï¼Œå¹¶è®°å½•å…¶å›è°ƒ
function Layer(path, options, fn) {
  if (!(this instanceof Layer)) {
    return new Layer(path, options, fn)
  }

  debug('new %o', path)
  var opts = options || {}

  this.handle = fn
  this.name = fn.name || '<anonymous>'
  this.params = undefined
  this.path = undefined
  this.regexp = pathRegexp(path, (this.keys = []), opts)

  // set fast path flags
  this.regexp.fast_star = path === '*'
  this.regexp.fast_slash = path === '/' && opts.end === false
}
```

é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬çŸ¥é“ express æ‰€æœ‰ path ç”Ÿæˆä¸€ä¸ª Router å¯¹è±¡ï¼Œå…¶ stack å±æ€§å†…æŒ‚è½½äº†æ‰€æœ‰ä¸­é—´ä»¶åŠå…¶æ‰§è¡Œæ–¹æ³•ï¼Œé‚£ä¹ˆï¼Œå½“æˆ‘ä»¬åœ¨è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå®é™…å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

```javascript
// application.js

app.all = function all(path) {
  this.lazyrouter()

  // è°ƒç”¨ router.route æ–¹æ³•
  var route = this._router.route(path)
  var args = slice.call(arguments, 1)

  for (var i = 0; i < methods.length; i++) {
    route[methods[i]].apply(route, args)
  }

  return this
}

// router/index.js
/**
 * ä¸ºæ¯ä¸ª path åˆ›å»ºä¸€ä¸ªæ–°çš„ Router å¯¹è±¡ï¼Œå¹¶å°†å¸¦æœ‰ç»“æŸæ ‡å¿—çš„ layer æ”¾åœ¨ stack çš„æœ€å
 * æ¯ä¸€ä¸ª route éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ä¸­é—´ä»¶å †æ ˆ
 */
proto.route = function route(path) {
  var route = new Route(path)

  var layer = new Layer(
    path,
    {
      sensitive: this.caseSensitive,
      strict: this.strict,
      end: true,
    },
    route.dispatch.bind(route)
  )

  layer.route = route

  this.stack.push(layer)
  return route
}

// ...è¿™é‡Œæˆ‘ä»¬çœç•¥äº†åŒ¹é…åˆ° path åçš„ä¸­é—´ç¯èŠ‚ï¼Œç›´æ¥çœ‹çœ‹å½“å‘ç”Ÿ router å†…å›è°ƒé”™è¯¯åï¼Œåœ¨ error handle å†…æ˜¯æ€ä¹ˆå¤„ç†çš„...

// router/layer.js

Layer.prototype.handle_error = function handle_error(error, req, res, next) {
  var fn = this.handle

  // å¦‚æœå›è°ƒå½¢å‚ä¸ªæ•°ä¸ç­‰äº 4ï¼Œç›´æ¥è·³è¿‡ï¼Œè¿”å›ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å¤„ç†
  if (fn.length !== 4) {
    return next(error)
  }

  // å¦åˆ™ï¼Œå¤„ç†é”™è¯¯ï¼Œä¸€èˆ¬åœ¨ fn å†…é€šè¿‡æ˜¾å¼è°ƒç”¨ `next(err)` æ¥ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å¤„ç†
  try {
    fn(error, req, res, next)
  } catch (err) {
    next(err)
  }
}
```

### é’ˆå¯¹é”™è¯¯æ•è·è¡¨ç°çš„åˆç†è§£é‡Š

é€šè¿‡å¯¹æºç çš„è§£æï¼Œæˆ‘ä»¬ä¸éš¾å¯¹ä¸Šè¿°é—®é¢˜åšå‡ºè§£é‡Šï¼šexpress() åœ¨ç”Ÿäº§å‡º app å®ä¾‹ä¹‹åï¼Œç»è¿‡ `use(), get()` ç­‰ä¸€ç³»åˆ—æ–¹å¼ä¸ºå…¶æ·»åŠ å›è°ƒæ–¹æ³•ï¼ˆä¸­é—´ä»¶ï¼‰ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šæŒ‰ç…§åŠ è½½é¡ºåºå°†å…¶å†™å…¥ `router.stack` æ•°ç»„å†…ï¼Œå½“æˆ‘ä»¬è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œä¼šæŒ‰ç…§ stack çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼›

ä½†æ˜¯**å½“ä¸”ä»…å½“ä¼ é€’ err å¯¹è±¡** æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œé”™è¯¯æ•è·çš„ä¸­é—´ä»¶ï¼Œè€Œè¿™ç§æƒ…å†µï¼š1) æ‰§è¡Œé”™è¯¯ï¼Œåœ¨ `get()` ç­‰è°ƒç”¨æ–¹æ³•å†…éƒ¨å‘ç”Ÿï¼›2) é€šè¿‡ `next(err)` æ˜¾å¼è°ƒç”¨ï¼›

å› æ­¤ï¼Œè¿™ä¹Ÿè§£é‡Šäº†å½“æˆ‘ä»¬æŠŠé”™è¯¯æ•è·ä¸­é—´ä»¶æ”¾åœ¨ä¸­é—´ä½ç½®æ—¶ï¼Œä¸è¢«æ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥è·³è¿‡æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå› ä¸ºå…¶ä¸Šä¸€ä¸ªä¸­é—´ä»¶æ˜¯è°ƒç”¨çš„ `next()` è€Œä¸æ˜¯ `next(err)`ï¼Œå³ä¸€æ—¦é”™è¯¯è¢«æ•è·åˆ°ï¼Œåªèƒ½é€šè¿‡ `next(err)` ç»§ç»­åœ¨ä¸­é—´å†…æµè½¬ï¼›

æœ€åï¼Œå½“å›è°ƒä¸ºç©ºæˆ–è€…æ˜¾å¼è°ƒç”¨ `done()` æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨ `finalHander` ä¸º statusCode å’Œ statusMessage è¿›è¡Œèµ‹å€¼!
