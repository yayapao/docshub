---
id: corevitals
title: Web Core Vitals
sidebar_label: Web Core Vitals
slug: corevitals
---


## Core Metrics

我们已经通过一些手段获取了一堆性能数据, 接下来我们要做的事情就是对这些数据进行分类和分析.

- [核心指标解读](https://web.dev/lcp/)

**像 LCP 这类属性会随着页面内资源加载而动态改变，针对此类问题，通过 `new PerformanceObserver()` 的 `observe()` 方法进行监听，来动态获取值**

<img src="/img/browser/wpm/corevitals.svg" />

如上图，展示了浏览器加载完资源之后的主线程执行情况！

### FP(First Paint)

通常等于 FCP，衡量标准类比

`FP = Anything as visually different - Navigator`, 即浏览器开始导航到浏览器屏幕发生可视化改变的时间间隔

```typescript
const entries = window.performance.getEntries()

entries.forEach(entry => {
  if (entry.name === 'first-paint') {
    crt['fp'] = +entry.startTime.toFixed(2)
  }
})
```



### FCP(First Contentful Paint)

**衡量标准**

- Good: < 1.8s
- Needs improvemnt: 1.8s ~ 3s
- Poor: > 3s

浏览器从导航到渲染 DOM 内容的第一个字节(就是一个 DOM 元素的第一个字节)所花费的时间, 通常情况下 FP 等于 FCP

```typescript
const entries = window.performance.getEntries()

entries.forEach(entry => {
  if (entry.name === 'first-contentful-paint') {
    crt['fcp'] = +entry.startTime.toFixed(2)
  }
})
```



### TBT(Total Blocking Time)

> < 300 milliseconds means good experience

TBT 指标用于测量 FCP 到 TTI 之间，主线程被阻塞的总时长

通常存在 `Long Task` 时，主线程就被认定为“阻塞”

运行在主线程且执行耗时大于 50 毫秒的任务被认定为 `Long Task`

```typescript
let tbt = 0  
const entries = window.performance.getEntries()
// total-block-timing
entries.forEach(entry => {
  if (entry.name !== 'self' || entry.startTime < crt.fcp) return
  if (entry.duration - 50 > 0) {
    tbt += entry.duration
  }
})
```






### DeviceMemory

通过 [navigator.deviceMemory](https://github.com/w3c/device-memory) 我们可以观察硬件的 RAM 信息

通常一个服务请求或者事件处理在不同内存设备下的表现会出现差异，Chrome telemetry 表明在低内存的设备 tab 上发生了大量的 OOM 崩溃。因此，我们需要收集该指标来作为分析的维度，也能够为我们提供 “lite” 版本的服务提供依据

其值为 GiB 中 RAM 数量的近似值

**The client hint header and API will only be available on HTTPS secure connections.**


## How to measure?

就让我们的探索旅程从 Chrome performance 的一个示例开始!

![perf overview](/img/browser/wpm/overview.gif)

我们可以观察到, 在 `Timings` 维度内, Chrome 观察了五个指标, 那么我们如何通过它提供的 API 来重新造一个轮子呢?

"磨刀不误砍柴工", 我们先来学习相关的 API



### Performace Entries

`PerformanceEntry` 对象表示 performance 时间线上一系列的指标(metric), 指标的来源可以分为两部分:

- 手动构建, 通过 `mark` 或者 `measure` 来生成
- 自动生成, 在资源加载时, 会被动生成(例如图片, script 等资源加载)

执行 `window.performance.getEntries()` 来获取当前应用的所有性能指标数据, 返回值为一个对象数组, 如下所示:

![perf overview](/img/browser/wpm/entry.png)

通过观察结果的 `key` 值, 大致分为四种类型:

- **PerformanceNavigationTiming**
- **PerformanceResourceTiming**
- **PerformancePaintTiming**
- **PerformanceEventTiming**

上面类型的公共属性:

- `name` 表示该 performance entry 的名称, 可以是资源名称、URL 或者自定义指标名等
- `entryType` 上报指标的类型, 这个由浏览器本身来进行定义, 参考 [MDN entryType](https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceEntry/entryType)
- `startTime` 指标开始上报的时间
- `duration` 该事件发生的整体耗时

此外, 各个类型(除 PerformancePaintTiming 外)还有其他更为详细的属性信息

