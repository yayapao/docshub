---
id: redis
title: 'redis'
sidebar_label: redis
---

## Redis

:::info

The open source, in-memory data store used by millions of developers as a database, cache, streaming engine, and message broker.

:::

不同环境下安装 redis

```sh
# MacOS
$ brew install redis

# Linux （仅支持 v5.0.7 版本）
apt update && apt install redis

# CentOS
yum install redis
```

在 Linux 下，apt 仅支持 v5.0.7 版本，如果需要安装更高版本 Redis，需要手动下载、编辑、安装。

```sh
# 编译需要用到 gcc，查看系统内是否已经安装
apt list gcc

# 下载指定版本源码
wget http://download.redis.io/releases/redis-7.0.5.tar.gz

# 解压下载产物，将其移动到 /usr/local
tar -xvf redis-7.0.5.tar.gz && mv redis-7.0.5 /usr/local

# 进入文件目录，编译
cd /usr/local/redis-7.0.5 && make && make install

# 在 src 目录下执行 redis-server redis-cli 等来执行命令
# 默认会以 /usr/local/redis-7.0.5/redis.conf 配置启动，可以新建一个 conf 并将 redis.conf 拷贝到指定目录下
# 通过 `./redis-server conf/redis.conf` 来指定配置文件
```

安装完成之后，通过 `redis-cli --version` 查看 cli 版本，`redis-server --version` 查看 redis 服务版本，验证安装是否成功。

通过 `ps -ef | grep redis` 查看服务是否运行，或者在 Linux Ubuntu 上通过 `systemctl status redis` 来查看服务运行情况，v5 以上默认自动运行。

### 启动 redis 服务

#### 设置后台启动

MacOS 下 `vim /usr/local/etc/redis.conf`，Linux 配置文件在 `/etc/redis/redis.conf`

- 找到 `daemonize` 选项，将其值设置为 `yes`
- MacOS 执行 `redis-server /usr/local/etc/redis.conf` 启动时添加配置
- Linux 执行 `systemctl start redis` 来重启 redis 服务
- `ps -ef | grep redis` 查看服务情况

#### 设置开机启动

MacOS

- 执行 `ln -f /usr/local/Cellar/redis/6.0.10/homebrew.mxcl.redis.plist ~/Library/LaunchAgents` 建立软连接，加入到 launchd 进程，当用户登录系统后会自动执行
- 执行 `launchctl load ~/Library/LaunchAgents/homebrew.mxcl.redis.plist` 加载任务

#### 设置远程连接

设置 `redis.conf` 的 bind 字段来支持网卡访问

```sh
# ifconfig(Linux) 查看本机网卡地址

# 修改 redis.conf
bind 127.0.0.1 [inet]
```

redis 默认没有密码，设置 `requirepass` 修改连接密码

### 运维排障技巧

#### 基于 `redis-cli` 排障

通过 redis-cli 来查看服务运行情况

- 连接 redis: `redis-cli -h [hots] -p [port] -a [auth/password]`
- 查看内存占用: `redis-cli [connnection params] info memory`
- 查看不同数据库内最大 key 等统计信息: `redis-cli [connection params] -n [db index] --bigkeys`

#### 批量删除 redis key

在 terminal 内执行 `redis-cli -h 127.0.0.1 -p 6379 keys "bull:q_perf:*" | xargs -r -t redis-cli -h 127.0.0.1 -p 6379 del`

注意：

- `|` 是管道符，需要在 shell 内执行
- `xargs -r` 当 xargs 的输入为空的时候则停止 xargs，不用再去执行了
- `xargs -t` 表示先打印命令，然后再执行
