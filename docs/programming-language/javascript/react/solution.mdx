---
id: solution
title: ''
sidebar_label: solution
---

import { DocsHeader } from '/src/components/Layout/DocsHeader'
import { HighlightWithText } from '/src/components/Highlights'

<DocsHeader
  title="React Solutions"
  description="å¯¹ React ç”Ÿäº§é—®é¢˜çš„æ·±åº¦æ€è€ƒğŸ¤”ã€‚"
  tags={['React']}
  links={[
    {
      label: 'Why does useRef solve the problem of stale state?',
      link: 'https://stackoverflow.com/questions/66622967/why-does-useref-solve-the-problem-of-stale-state',
    },
    {
      label: 'Rename A File With JavaScript In The Browser',
      link: 'https://pqina.nl/blog/rename-a-file-with-javascript/',
    },
  ]}
/>{' '}

## åœ¨ React å†…å¤„ç†æ–‡ä»¶

:::caution Before we start

[File](https://developer.mozilla.org/en-US/docs/Web/API/File) å¯ä»¥çœ‹ä½œæ˜¯ Blob çš„ä¸€ç§ç‰¹æ®Šå®ç°ï¼Œå› æ­¤å®ƒå…·å¤‡ Blob çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜ `name`, `lastModified` ä»¥åŠ `webkitRelativePath` ç­‰å±æ€§

**æ­£æ˜¯ç”±äº File çš„å±æ€§ä¸º readonlyï¼Œä½¿æˆ‘ä»¬åœ¨è¯•å›¾æ”¹å˜å®ƒæ—¶é‡åˆ°éº»çƒ¦ã€‚**

:::

æœ¬ç« èŠ‚ï¼Œæˆ‘å°†åŸºäº React ç»“åˆ [filepond](https://pqina.nl/filepond/docs/) æ¥ä»‹ç»åœ¨ç°ä»£æ¡†æ¶å†…**å¤„ç†ä¸Šä¼ æ–‡ä»¶çš„éœ€æ±‚**ï¼ŒåŒæ—¶æä¾›è®¾è®¡ä¸Šä¼ ç»„ä»¶çš„æ€è·¯å’Œç»†èŠ‚ã€‚

è§‚å¯Ÿ filepond æˆ‘å‘ç°ï¼Œå®ƒåœ¨å¤„ç†æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œæ”¯æŒï¼š

- åœ¨æ–‡ä»¶å¯¹è±¡è¢«å‘é€åˆ°æœåŠ¡å™¨ä¹‹å‰ï¼Œé€šè¿‡å†…ç½®å’Œè‡ªå®šä¹‰æ’ä»¶ï¼Œæ›´æ”¹æ–‡ä»¶å¯¹è±¡ï¼Œæ¯”å¦‚é‡å‘½åã€é¢„è§ˆç­‰æ“ä½œ
- å¯¹äºå·²ä¸Šä¼ æ–‡ä»¶ï¼Œæ”¯æŒé»˜è®¤åˆ é™¤æ“ä½œï¼Œä¼šåŒæ—¶åˆ é™¤æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ–‡ä»¶å¯¹è±¡

![file-handler.png](https://img.joyjoy.cc/react/file-handler.png)

1. å½“ç”¨æˆ·ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª File å¯¹è±¡ï¼Œè¯¥ File å¯¹è±¡åªè¯»ï¼›
2. filepond æ’ä»¶åŸºäºåŸ File å¯¹è±¡ï¼Œåˆ›å»ºæ–°çš„ File å¯¹è±¡æ¥è§„é¿åªè¯»çš„é™åˆ¶ ğŸš«ï¼›
3. é€šè¿‡ File å¯¹è±¡ç”Ÿæˆæœ¬åœ° URL æ¥é¢„è§ˆå›¾ç‰‡ï¼›
4. æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éœ€è¦è¾¾æˆæŸç§çº¦å®šï¼Œå³å½“ä¸Šä¼ æˆåŠŸåï¼Œå°†æ–‡ä»¶ ID ä»¥çº¦å®šå½¢å¼è¿”å›ï¼Œç»„ä»¶ä»ç»“æœå†…å–å‡ºåæ”¾å»å†…å­˜ï¼Œä»è€Œè¿›è¡Œåç»­åˆ é™¤ç­‰æ“ä½œï¼›
5. ä¸åŒæµè§ˆå™¨åœ¨å¤„ç† File å¯¹è±¡æ—¶ï¼Œå¯èƒ½ä¼šå°†å…¶è½¬æ¢ä¸º Blob å¯¹è±¡ï¼Œ**æœåŠ¡ç«¯æ¥æ”¶ Blob å¯¹è±¡åï¼Œä¼šå°†å…¶ filename è§£ææˆ blob**ã€‚å› æ­¤ï¼Œéœ€è¦ç¡®ä¿ä¸Šä¼ æ•°æ®ä¸º Fileã€‚

### é‡å‘½å File

ä»¥é‡å‘½åä¸ºä¾‹ï¼Œå½“æˆ‘ä»¬éœ€è¦æ›´æ”¹ File çš„å±æ€§æ—¶ï¼Œ**ç›®å‰æ ‡å‡†çš„è§£å†³æ–¹æ¡ˆæ—¶ï¼Œä»¥åŸ File å¯¹è±¡ä¸ºåŸºç¡€ï¼Œç”Ÿäº§ä¸€ä¸ªæ–°çš„ Blob å¯¹è±¡ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º File å¯¹è±¡ã€‚**

_ä¸ºä»€ä¹ˆä¸æ˜¯ç›´æ¥ç”Ÿäº§ File å¯¹è±¡ï¼Ÿ_

- ä¸åŒæµè§ˆå™¨å¯¹äº File å¯¹è±¡çš„å¤„ç†å­˜åœ¨å·®å¼‚
- `Blob.slice` ä¼šè¿”å›ä¸€ä¸ª Blob å¯¹è±¡

```js
const renameFile = (file, name) => {
  // æ–°å»ºä¸€ä¸ª Blob å¯¹è±¡ï¼ŒæŒ‡å®šå¼€å§‹/ç»“æŸä½ç½®å’Œæ•°æ®ç±»å‹ï¼Œå¹¶ä¸ºå…¶é‡å‘½å
  const renamedFile = file.slice(0, file.size, file.type)
  renamedFile.lastModifiedDate = file.lastModifiedDate
  renamedFile.name = name
  // å°† Blob å¯¹è±¡è½¬æ¢ä¸º File
  const form = new FormData()
  form.set('file', renamedFile, name)
  return form.get('file')
}
```

### æœ¬åœ°é¢„è§ˆæ–‡ä»¶

è¿™é‡Œç‰¹æŒ‡æµè§ˆå™¨å¯ä»¥æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ image/\*, SVG, ä»¥åŠ PDF ç­‰æ ¼å¼æ–‡ä»¶ã€‚

1. é€šè¿‡ `window.URL.createObjectURL(file)` æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªé“¾æ¥ï¼Œå°†è¿”å›å€¼æ”¾å…¥ img.src å±æ€§å†…ï¼›
2. é€šè¿‡ `FileReader` å°†æ–‡ä»¶å†…å®¹è½¬ä¸º base64 æ ¼å¼ï¼Œè¿›è¡Œè¯»å–ï¼›

```js filereader
var fileReader = new FileReader()

reader.onload = function (e) {
  // base64 ç¼–ç 
  const res = e.target.result
}
reader.readAsDataURL(file)
```

## React Closure

:::caution closure

é—­åŒ…é—®é¢˜ä¸€ç›´å›°æ‰°ç€ JavaScript å¼€å‘è€…ï¼Œå› ä¸ºå®ƒå¾€å¾€ä¸ä¼šäº§ç”ŸæŠ¥é”™ï¼Œä½†æ˜¯å®é™…å½±å“äº†ç¨‹åºæ­£ç¡®æ‰§è¡Œã€‚

:::

åœ¨ React å†…ï¼Œå‡½æ•°ç»„ä»¶ç®€åŒ–äº†ç»„ä»¶çŠ¶æ€å’Œ side effect çš„ç®¡ç†ï¼Œå› æ­¤ç»„ä»¶å–ä»£ class æˆä¸ºæˆ‘ä»¬çš„å¼€å‘ä¸»åŠ›ã€‚Hooks é«˜åº¦ä¾èµ–é—­åŒ…ï¼Œé—­åŒ…é—®é¢˜çš„é£é™©ä¹Ÿéšä¹‹è€Œæ¥ã€‚

è§‚å¯Ÿä¸‹é¢è¿™æ®µç¨‹åºï¼Œæˆ‘ä»¬åœ¨ `mounted` æ—¶å»ºç«‹äº†ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨æ¥ç›‘å¬é”®ç›˜äº‹ä»¶ï¼Œåœ¨é”®å…¥ enter æ—¶ï¼Œè°ƒç”¨ `onSearch` æ–¹æ³•ï¼Œæ‰“å°å½“å‰ valueã€‚

![react-closure.jpg](https://img.joyjoy.cc/react/react-closure.jpg)

äº‹å®ä¸Šï¼Œæ— è®ºæˆ‘ä»¬è¾“å…¥ä»€ä¹ˆï¼Œé”®å…¥ enter æ—¶éƒ½ä¼šæ‰“å° `undefined`ï¼Œ**å®ƒä»£è¡¨ value çš„åˆå§‹çŠ¶æ€**ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»æ‰å…¥äº† **é—­åŒ…é™·é˜±ã€‚**

### é—­åŒ…æ˜¯å¦‚ä½•å‘ç”Ÿçš„å‘¢ï¼Ÿ

æˆ‘ä»¬å¸Œæœ›åœ¨å‡½æ•°ç»„ä»¶ mounted æ—¶ï¼Œå»ºç«‹å¯¹é”®ç›˜äº‹ä»¶çš„ç›‘å¬ã€‚

```tsx
useEffect(() => {
  window.addEventListener('keydown', handleKeyDown, false)
  return () => {
    window.removeEventListener('keydown', handleKeyDown, false)
  }
}, [])
```

æ­¤æ—¶ useEffect å›è°ƒå‡½æ•°çš„ç¯å¢ƒæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ‰§è¡Œ `window.addEventListener` æ“ä½œï¼ˆåŒç†è¿˜æœ‰ setTimeout/setInterval ç­‰æ“ä½œï¼‰ï¼Œæ­¤æ—¶ `handleKeyDown` å†…å½¢æˆ stale colsureï¼Œå…¶ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§æ˜¯ä¿ç•™æ—§çš„å˜é‡çŠ¶æ€ã€‚

å½“ value å˜åŒ–å¼•èµ· SearchBar å‘ç”Ÿ re-render åï¼Œä¸å†è§¦å‘ `mounted` hookï¼Œå³ä¸ä¼šå†æ¬¡å£°æ˜/æ‰§è¡Œä¸Šæ–‡ä¸­ useEffect å†…çš„ä»£ç ã€‚**å½“æˆ‘ä»¬é”®å…¥ enter åï¼Œä¼šè°ƒç”¨â€œæ—§çš„â€ handleKeyDown æ–¹æ³•ï¼Œå®ƒçš„å˜é‡å¯¹è±¡ä»ä¸ºé¦–æ¬¡å®šä¹‰çš„å€¼ã€‚**å› æ­¤ï¼Œæœ€ç»ˆè¾“å‡ºä¸º undefinedã€‚

### å¦‚ä½•è§£å†³ï¼Ÿ

åŸå› æ˜¯åœ¨å‡½æ•°ç»„ä»¶ re-render ä¹‹åï¼Œè§¦å‘æ–¹æ³•ä»ä¼šè®¿é—®æ—§çš„å˜é‡å¯¹è±¡ï¼Œå¯¼è‡´å¼‚å¸¸è¡¨ç°ã€‚è¿™é‡Œæˆ‘ä»¬æä¾›ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

1. ğŸ‘ é€šè¿‡ `useRef` ä¿è¯è®¿é—®å¯¹è±¡å§‹ç»ˆä¸ºæœ€æ–°ï¼›
2. ä¿è¯æ¯æ¬¡ re-render æ—¶ï¼Œé‡æ–°ç»‘å®šå‡½æ•°**ï¼ˆä¸æ¨èï¼Œä¼šå¯¼è‡´äº‹ä»¶é¢‘ç¹å‘ç”Ÿç»‘å®š/è§£ç»‘æ“ä½œï¼Œæ¶ˆè€—æµè§ˆå™¨å†…å­˜ï¼‰**ï¼›

```tsx
// code snippets
const [value, setValue] = useState<string>()
const valueRef = useRef<string>()

const onSearch = () => {
  console.log(valueRef.current)
}

useEffect(() => {
  valueRef.current = value
}, [value])
```

ä¸ºä»€ä¹ˆ `useRef` è¡Œä¹‹æœ‰æ•ˆï¼Ÿ

å› ä¸º useRef åœ¨å‘ç”Ÿ re-render æ—¶ï¼Œæ€»æ˜¯è¿”å›ç›¸åŒçš„å¯¹è±¡å¼•ç”¨ï¼Œè¿™ä¿è¯åœ¨ä¸åŒå†…éƒ¨å‡½æ•°å†…èƒ½å¤Ÿè®¿é—®åˆ°ä¸€è‡´çš„æ•°æ®ã€‚åŒæ—¶ï¼Œæ¯æ¬¡å‡½æ•°ç»„ä»¶é‡æ–°æ‰§è¡Œæ—¶ï¼Œä¼šå°†æœ€æ–°çš„ value èµ‹å€¼ç»™ ref.currentï¼Œä»è€Œä¿è¯æ¯æ¬¡è®¿é—®çš„éƒ½æ˜¯æœ€æ–°çš„å€¼ã€‚
