---
id: solution
title: ''
sidebar_label: solution
---

import { DocsHeader } from '/src/components/Layout/DocsHeader'
import { HighlightWithText } from '/src/components/Highlights'

<DocsHeader
  title="React Solutions"
  description="å¯¹ React ç”Ÿäº§é—®é¢˜çš„æ·±åº¦æ€è€ƒğŸ¤”ã€‚"
  tags={['React']}
  links={[
    {
      label: 'Why does useRef solve the problem of stale state?',
      link: 'https://stackoverflow.com/questions/66622967/why-does-useref-solve-the-problem-of-stale-state',
    },
  ]}
/>{' '}

## React Closure

:::caution closure

é—­åŒ…é—®é¢˜ä¸€ç›´å›°æ‰°ç€ JavaScript å¼€å‘è€…ï¼Œå› ä¸ºå®ƒå¾€å¾€ä¸ä¼šäº§ç”ŸæŠ¥é”™ï¼Œä½†æ˜¯å®é™…å½±å“äº†ç¨‹åºæ­£ç¡®æ‰§è¡Œã€‚

:::

åœ¨ React å†…ï¼Œå‡½æ•°ç»„ä»¶ç®€åŒ–äº†ç»„ä»¶çŠ¶æ€å’Œ side effect çš„ç®¡ç†ï¼Œå› æ­¤ç»„ä»¶å–ä»£ class æˆä¸ºæˆ‘ä»¬çš„å¼€å‘ä¸»åŠ›ã€‚Hooks é«˜åº¦ä¾èµ–é—­åŒ…ï¼Œé—­åŒ…é—®é¢˜çš„é£é™©ä¹Ÿéšä¹‹è€Œæ¥ã€‚

è§‚å¯Ÿä¸‹é¢è¿™æ®µç¨‹åºï¼Œæˆ‘ä»¬åœ¨ `mounted` æ—¶å»ºç«‹äº†ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨æ¥ç›‘å¬é”®ç›˜äº‹ä»¶ï¼Œåœ¨é”®å…¥ enter æ—¶ï¼Œè°ƒç”¨ `onSearch` æ–¹æ³•ï¼Œæ‰“å°å½“å‰ valueã€‚

![react-closure](https://img.joyjoy.cc/docs/plang/react/react-closure.jpg)

äº‹å®ä¸Šï¼Œæ— è®ºæˆ‘ä»¬è¾“å…¥ä»€ä¹ˆï¼Œé”®å…¥ enter æ—¶éƒ½ä¼šæ‰“å° `undefined`ï¼Œ**å®ƒä»£è¡¨ value çš„åˆå§‹çŠ¶æ€**ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»æ‰å…¥äº† **é—­åŒ…é™·é˜±ã€‚**

### é—­åŒ…æ˜¯å¦‚ä½•å‘ç”Ÿçš„å‘¢ï¼Ÿ

æˆ‘ä»¬å¸Œæœ›åœ¨å‡½æ•°ç»„ä»¶ mounted æ—¶ï¼Œå»ºç«‹å¯¹é”®ç›˜äº‹ä»¶çš„ç›‘å¬ã€‚

```tsx
useEffect(() => {
  window.addEventListener('keydown', handleKeyDown, false)
  return () => {
    window.removeEventListener('keydown', handleKeyDown, false)
  }
}, [])
```

æ­¤æ—¶ useEffect å›è°ƒå‡½æ•°çš„ç¯å¢ƒæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ‰§è¡Œ `window.addEventListener` æ“ä½œï¼ˆåŒç†è¿˜æœ‰ setTimeout/setInterval ç­‰æ“ä½œï¼‰ï¼Œæ­¤æ—¶ `handleKeyDown` å†…å½¢æˆ stale colsureï¼Œå…¶ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§æ˜¯ä¿ç•™æ—§çš„å˜é‡çŠ¶æ€ã€‚

å½“ value å˜åŒ–å¼•èµ· SearchBar å‘ç”Ÿ re-render åï¼Œä¸å†è§¦å‘ `mounted` hookï¼Œå³ä¸ä¼šå†æ¬¡å£°æ˜/æ‰§è¡Œä¸Šæ–‡ä¸­ useEffect å†…çš„ä»£ç ã€‚**å½“æˆ‘ä»¬é”®å…¥ enter åï¼Œä¼šè°ƒç”¨â€œæ—§çš„â€ handleKeyDown æ–¹æ³•ï¼Œå®ƒçš„å˜é‡å¯¹è±¡ä»ä¸ºé¦–æ¬¡å®šä¹‰çš„å€¼ã€‚**å› æ­¤ï¼Œæœ€ç»ˆè¾“å‡ºä¸º undefinedã€‚

### å¦‚ä½•è§£å†³ï¼Ÿ

åŸå› æ˜¯åœ¨å‡½æ•°ç»„ä»¶ re-render ä¹‹åï¼Œè§¦å‘æ–¹æ³•ä»ä¼šè®¿é—®æ—§çš„å˜é‡å¯¹è±¡ï¼Œå¯¼è‡´å¼‚å¸¸è¡¨ç°ã€‚è¿™é‡Œæˆ‘ä»¬æä¾›ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

1. ğŸ‘ é€šè¿‡ `useRef` ä¿è¯è®¿é—®å¯¹è±¡å§‹ç»ˆä¸ºæœ€æ–°ï¼›
2. ä¿è¯æ¯æ¬¡ re-render æ—¶ï¼Œé‡æ–°å£°æ˜è°ƒç”¨å‡½æ•°**ï¼ˆä¸æ¨èï¼Œä¼šå¯¼è‡´äº‹ä»¶é¢‘ç¹å‘ç”Ÿç»‘å®š/è§£ç»‘æ“ä½œï¼Œæ¶ˆè€—æµè§ˆå™¨å†…å­˜ï¼‰**ï¼›

```tsx
// code snippets
const [value, setValue] = useState<string>()
const valueRef = useRef<string>()

const onSearch = () => {
  console.log(valueRef.current)
}

useEffect(() => {
  valueRef.current = value
}, [value])
```

ä¸ºä»€ä¹ˆ `useRef` è¡Œä¹‹æœ‰æ•ˆï¼Ÿ

å› ä¸º useRef åœ¨å‘ç”Ÿ re-render æ—¶ï¼Œæ€»æ˜¯è¿”å›ç›¸åŒçš„å¯¹è±¡å¼•ç”¨ï¼Œè¿™ä¿è¯åœ¨ä¸åŒå†…éƒ¨å‡½æ•°å†…èƒ½å¤Ÿè®¿é—®åˆ°ä¸€è‡´çš„æ•°æ®ã€‚åŒæ—¶ï¼Œæ¯æ¬¡å‡½æ•°ç»„ä»¶é‡æ–°æ‰§è¡Œæ—¶ï¼Œä¼šå°†æœ€æ–°çš„ value èµ‹å€¼ç»™ ref.currentï¼Œä»è€Œä¿è¯æ¯æ¬¡è®¿é—®çš„éƒ½æ˜¯æœ€æ–°çš„å€¼ã€‚
