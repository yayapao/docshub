---
id: npm
title: ''
sidebar_label: npm
---

import { DocsHeader } from '/src/components/Layout/DocsHeader'
import {
  HighlightWithCode,
  HighlightWithText,
} from '/src/components/Highlights/TextContent'
import { ResolvedTag } from '/src/components/Highlights/CustomizedTag'

<DocsHeader
  title="NPM Guidebook"
  description="npm 是一个 Node.js 的包管理工具，也是基于 Node.js 开源项目的仓库，同时也是一个 cli 工具"
  tags={['Node.js']}
  links={[
    {
      label: `what's npm?`,
      link: 'https://www.npmjs.com/about',
    },
    {
      label: `npm-run-script`,
      link: 'https://docs.npmjs.com/cli/v8/commands/npm-run-script',
    },
    {
      label: 'Selective dependency resolutions',
      link: 'https://classic.yarnpkg.com/lang/en/docs/selective-version-resolutions/',
    },
  ]}
/>

<!-- -->

## 执行 `npm run X` 的过程？

`npm run` 是 `npm run-scripts` 的代称，用来执行 package.json 内 `scripts` 字段所对应的脚本。

那么当我们在执行 `npm run X` 时，实际发生了什么？

**In one word：`npm run` 的本质是执行脚本，并且 npm 处理了寻找可执行脚本的过程。**

假设我们在 package.json 内有如下配置：

```json

"scripts": {
  "dev": "umi dev",
},

```

当执行 `npm run dev` 时，npm 会先在 **本地 `node_modules/.bin`目录下找寻 `umi` 命令**，找到之后立即执行，相当于 `node_modules/.bin umi dev`。如果没有找到，会在全局安装的 node_modules 内继续寻找。

`node_modules/.bin` 内存放的实际上是各个执行脚本的软链接（Symbolic link），`umi` 实际指向 `node_modules/umi/bin/umi.js`

- 这里的实际指向路径由 **node_modules/umi/package.json** 的 `bin` 配置决定
- 当执行 `npm install umi` 时，npm 会读取 umi 内的 `bin` 声明，并将相应文件（这里指 `node_modules/umi/bin/umi.js`）软链接到 `node_modules/.bin` 目录下
- 同时，npm 会将 `node_modules/.bin` 加入到 **$PATH**，从而可以直接作为命令运行依赖程序和开发依赖程序

## npm 常用命令

**更换源库地址**

- 查看当前仓库源地址 `npm config get registry`
- 临时换源 `npm --registry https://registry.npmjs.org/ install [package]`
- 永久更换 `npm config set registry https://registry.npmjs.org/`

**查看**

- 查看全局安装包 `npm ls -g --depth 0`
- 检索本地/全局是否安装指定包 `npm ls [package name] [-g]`
- 查看 npm 全局包安装路径 `npm get prefix`，**注意**，使用 volta 管理 Node.js 时，其安装路径在 `../packages` 目录下

**执行指定路径的脚本**

npm 默认执行根目录下，package.json 内的命令，可以通过配置：

`npm --prefix /path/to/project run build`，其中 /path/to/project 表示指定目录，其目录下必须包含 `package.json`

### npm publish 指定文件（或者指定不发布的文件）

开始在使用 npm 进行发布时，会发现总是将一些不需要的文件打包进去，可以通过发布时的 `Tarball Contents` 来观察打包文件，或者在 [npm](https://www.npmjs.com/) 内通过 Total Files 进行查看

当然，打包进去的文件越精简越好，这样能够减少包的大小，更加轻量，那么我们应该怎么达到目的呢？

1. 通过设置 `.gitignore` 使其在 git 代码管理和 npm publish 内同时生效；
2. 通过设置 `.npmignore` ，其设置语法和 `.gitignore` 一致，但是**优先级更高！**
3. 通过设置 `package.json` 内的 [files](https://docs.npmjs.com/cli/v7/configuring-npm/package-json#files) 字段来选择发布的文件或者目录，其优先级在同级目录下时更高！

## package.json

package.json 要点

![package](/img/server/package.json.png)

## How to manage Dependencies?

### `ncu` 升级依赖

通过 `yarn upgrade | upgrade-interactive` 升级依赖版本时，仅会更新 _yarn.lock_ 文件，_package.json_ 并不会被更新，为了解决此问题，我们选择社区解决方案 - [npm-check-updates](https://www.npmjs.com/package/npm-check-updates)

```bash
# 检查所有依赖，更新 package.json 文件，之后执行 `yarn install` 更新依赖
ncu -u

# 升级指定文件
ncu -f @tanstack/react-query -u
```

### `yarn resolution` 来管理包的依赖包版本

通俗来说，就是我们通过 `yarn add` 引入的依赖包内可能同时依赖其他包（即**次级依赖包**），如果在依赖包内没有指定版本的话，默认会拉取其最新版本，这样做会产生问题，因为 yarn 通过支持 `resolutions` 字段来显式指定依赖包的版本（之前会更改 yarn.lock 文件）

**为什么需要 resolutions 参数？**

- 直接依赖的包可能不频繁更新，但是次级依赖包可能发布了一个重大更新，此时你可能需要等待作者去处理后发布
- 次级依赖包暴露出一个重大的安全漏洞
- 次级依赖包和当前其他直接依赖不兼容，需要将次级依赖包回退

**举个例子**

`NPM package cannot be used as a JSX Component - Type errors` 在 React v17 到 v18 内常见问题。

原因是 `@types/react-dom` 内依赖 `@types/react` 并将其版本设置为 \*，这就会导致，即使 `@types/react-dom` 拉取的版本是 v17，但是拉取的 `@types/react` 为 v18，从而造成上诉问题。

解决方案是在 package.json 内设置（根据实际情况灵活设置）：

```json
"resolutions": {
  "@types/react": "17.0.0",
  "@types/react-dom": "17.0.0"
}
```

## Troubleshooting

### bad interpreter: No such file or directory

当发布一个 package 后，准备执行脚本，发现报错 `usr/bin/env: bad interpreter: No such file or directory`.

原因：脚本文件的 shell 声明错误

```js
// error declare
#!usr/bin/env node

// correct declare
#!/usr/bin/env node
```

### sill install loadIdealTree

<HighlightWithText>
  Q: 安装 pm2 时，npm install 卡在 sill install loadIdealTree？
</HighlightWithText>{' '}

```
1. 更换 npm 源 `https://registry.npm.taobao.org/`
2. 删除 package-lock.json, node_modules 后，重新安装
```

### Hostname/IP address doesn't match

<HighlightWithText>
  Q: NPM not installing package. Hostname/IP address doesn't match certificate's
  altnames?
</HighlightWithText>{' '}

参考 [NPM not installing package. Hostname/IP address doesn't match certificate's altnames?](https://stackoverflow.com/questions/52128212/npm-not-installing-package-hostname-ip-address-doesnt-match-certificates-altn)，问题在于当前拉取的 npm 源不对。

```shell
# 获取 www.npmjs.com ip
dig www.npmjs.com @1.1.1.1
# 配置 hosts 文件
vim /etc/hosts

104.16.92.83 registry.npmjs.org

# 或者更换源，注意 http/https 区别
npm config set registry http://registry.npmjs.org
```
