---
id: faq
title: FAQ
sidebar_label: FAQ
---

import {
  HighlightWithText,
  HighlightWithCode,
} from '/src/components/Highlights'

## Issues

### 信息被 `[Filtered]` 占位

在查看错误字段时，发现信息被 `[Filtered]` 占位，并展示 `Replaced because PII rule "@xxxxxx:filter"`

是由于 sentry 匹配到敏感信息，并对其进行处理。**请确认该信息是否有能够展示！**

用户可以配置 `setting > Security & Privacy > Safe Feilds` 来放开指定敏感字段

### 在 Issues 内无法通过 SourceMap 定位到源码

出现这种问题，我们一般从两个方向进行排查：

1. 上传前置工作是否正确
2. SourceMap 文件路径能否匹配

针对以上两点，我们需要从以下方面来进行排查：

- SDK 内是否配置 `release`，并配置对应版本，可以在平台内进行验证
- 是否上传 SourceMap 文件到指定的 release 版本内，可以在平台内 `Setting > Source Maps` 模块进行验证，可以查看是否有上传 Artifacts，能够在指定 release 内找到指定 .map 文件
- 查看源文件内，`sourceMappingURL` 是否被改写（系统会通过该字段来匹配 source map 文件），一些 CNDs 会更加优化而对静态文件进行处理，比如去掉文件内注释等
- 确保 SDK 内 `dist` 配置与上传 SourceMap 时配置一致。可以在 Issues 内检查是否存在 `dist` 标签来验证是否在 SDK 配置了该字段，而在 SourceMap 内可以检查右下角是否有一个小椭圆来验证
- 检查路径（文件名）是否匹配，如果路径中存在动态值，可以使用 `rewriteFrames` 来进行处理
- 确保 `artifacts` 在错误发生之前下载完成

## Relay response 400

部署上线之后，发现 sentry 服务的域名产生大量的 400 错误，通过查看 `relay` 日志，我们发现了一些异常，这里我们通过阅读源码对其表现和解决方案进行记录

Relay 返回400的场景

- 🐛 Too many envelopes (event_buffer_size reached)
- 🐛 invalid security report type
- 一些浏览器请求代理插件/扩展，会先触发一个 `Type=ping` 的请求，再发起真实请求，此时 ping 请求会返回 400
- 在 relay 的 envelope 接口内上报了自定义的字段，导致 relay 无法解析，详见[fix(server): Accept and forward unknown envelope items](https://github.com/getsentry/relay/pull/1246)

### Too many envelopes (event_buffer_size reached)

如果我们在服务上发现了大量的 400 状态码，通常是由该原因导致

```rust
[relay_server::endpoints::common] ERROR: error handling request: failed to queue envelope
caused by: Too many envelopes (event_buffer_size reached)
```

通过分析 relay 源码，我们发现一些端倪：

`relay-server/src/actors/envelopes.rs`

```rust
// 如果缓冲区内堆积值超过设置阈值，返回错误和详情
if self.config.envelope_buffer_size() <= self.active_envelopes {
  return Err(QueueEnvelopeError::TooManyEnvelopes);
}

#[derive(Debug, Fail)]
pub enum QueueEnvelopeError {
  #[fail(display = "Too many envelopes (event_buffer_size reached)")]
  TooManyEnvelopes,
}
```

`relay-server/src/endpoints/common.rs`

```rs
// 定义错误信息
#[derive(Fail, Debug)]
pub enum BadStoreRequest {
  #[fail(display = "failed to queue envelope")]
  QueueFailed(#[cause] QueueEnvelopeError)
}

impl BadStoreRequest {
  fn to_outcome(&self) -> Option<Outcome> {
    Some(match self {
      BadStoreRequest::QueueFailed(event_error) => match event_error {
        QueueEnvelopeError::TooManyEnvelopes => Outcome::Invalid(DiscardReason::Internal),
      },
    })
  }
}
```

<HighlightWithText text="错误原因" />{' '}

当 `envelope` 处理对列堆积超过 [Config::event_buffer_size](https://docs.sentry.io/product/relay/options/)(默认为 1000) 时，会返回 400 错误。请求包含所有类型的 events、attachments 和 sessionsrelay。

### invalid security report type

报错信息如下：

```
[relay_server::actors::envelopes] ERROR: failed to extract security report: invalid security report type
```

该问题相关 issues:
- [Rejected CSP reports from Firefox latest due to missing effective-directive payload](https://github.com/getsentry/sentry/issues/31433)

我们对其源码进行分析后发现：

`relay-server/src/actors/envelopes.rs`

```rs
// 按照如下顺序从 envelope 内提取事件的 payload，事件仅从一个源内获取：
// 1. 显式事件，理解为通过 SDK 正常上报的事件；
// 2. 安全上报项，由浏览器根据安全策略上报；
// 3. Attachments `__sentry-event` and `__sentry-breadcrumb1/2`
// 4. 表单数据
fn extract_event(&self, state: &mut ProcessEnvelopeState) -> Result<(), ProcessingError> {
  if let Some(mut item) = raw_security_item {
      relay_log::trace!("processing security report");
      state.sample_rates = item.take_sample_rates();
      self.event_from_security_report(item).map_err(|error| {
          relay_log::error!("failed to extract security report: {}", LogError(&error));
          error
      })?
  }
}

// 定义错误信息
#[derive(Debug, Fail)]
enum ProcessingError {
  #[fail(display = "invalid security report type")]
  InvalidSecurityType
}

fn event_from_security_report(&self, item: Item) -> Result<ExtractedEvent, ProcessingError> {
    let len = item.len();
    let mut event = Event::default();

    let data = &item.payload();
    // 未能通过 payload 推断出其安全策略，直接返回错误
    let report_type = SecurityReportType::from_json(data)
        .map_err(ProcessingError::InvalidJson)?
        .ok_or(ProcessingError::InvalidSecurityType)?;

    let apply_result = match report_type {
        SecurityReportType::Csp => Csp::apply_to_event(data, &mut event),
        SecurityReportType::ExpectCt => ExpectCt::apply_to_event(data, &mut event),
        SecurityReportType::ExpectStaple => ExpectStaple::apply_to_event(data, &mut event),
        SecurityReportType::Hpkp => Hpkp::apply_to_event(data, &mut event),
    };

    if let Err(json_error) = apply_result {
        // logged in extract_event
        relay_log::configure_scope(|scope| {
            scope.set_extra("payload", String::from_utf8_lossy(data).into());
        });

        return Err(ProcessingError::InvalidSecurityReport(json_error));
    }
}
```

`relay-general/src/protocol/security_report.rs`

```rs
// 根据 paylod 来推断当前安全策略类型，如果没有匹配上，会直接返回错误
impl SecurityReportType {
  pub fn from_json(data: &[u8]) -> Result<Option<Self>, serde_json::Error> {
      #[derive(Deserialize)]
      #[serde(rename_all = "kebab-case")]
      struct SecurityReport {
          csp_report: Option<IgnoredAny>,
          known_pins: Option<IgnoredAny>,
          expect_staple_report: Option<IgnoredAny>,
          expect_ct_report: Option<IgnoredAny>,
      }

      let helper: SecurityReport = serde_json::from_slice(data)?;

      Ok(if helper.csp_report.is_some() {
          Some(SecurityReportType::Csp)
      } else if helper.known_pins.is_some() {
          Some(SecurityReportType::Hpkp)
      } else if helper.expect_staple_report.is_some() {
          Some(SecurityReportType::ExpectStaple)
      } else if helper.expect_ct_report.is_some() {
          Some(SecurityReportType::ExpectCt)
      } else {
          None
      })
  }
}
```

<HighlightWithText text="错误原因" />{' '}

浏览器通过安全策略上报的数据未能被 sentry 识别。

## Development

### 找不到 `performance` 入口

在本地部署 Sentry 后，发现找不到 performance 模块的入口

- 原因：Sentry v21.6.3 默认不支持 performance 特性，需要手动配置进行开启
- 解决：在 `~/.sentry/sentry.config.py` 内进行配置

参考[sentry.config.js](https://github.com/getsentry/self-hosted/blob/master/sentry/sentry.conf.example.py)

```python
############
# Features #
############

SENTRY_FEATURES["organizations:performance-view"] = True
```

### invaild platform

在本地创建项目后，发现 `POST /api/0/teams/sentry/sentry/projects/` 报错 `400 invaild platform`

- 查看源码发现程序需要读取 `integration-docs` 目录下的文件，返回静态页面
- 通过执行 `sentry repair --with-docs` 拉取最新的集成列表，安装在本地的 sentry 内
