---
id: development
title: Development
sidebar_label: Development
---

import { HighlightWithText } from '../../../src/components/Highlights'

:::caution 前置准备

具体环境配置、依赖安装和本地运行参考[self-hosted](./self_hosted#环境准备)

:::

我们希望基于源码对服务进行拓展和优化，将按照 **运行时环境 + 源码 + 配置 + 执行脚本** 的思路进行。

## Sentry-cli 使用

### 发送一个 event

参考 [Sending Events](https://docs.sentry.io/product/cli/send-event/) 使用 Sentry-cli 来快速发送一个事件。

将 DSN 写入环境变量

```bash
export SENTRY_DSN='Project's DSN'
```

发射事件

```bash
sentry-cli send-event -m 'message'
```

## 基于 API 进行二次开发

### FAQ

#### 如何统计每个 team 的日均 events?

根据 Sentry API Docs 我们无法直接获取每个 team 的数据统计，因此我们需要：

1. 获取指定 team 的 projects，见[list-a-teams-projects](https://docs.sentry.io/api/teams/list-a-teams-projects/)
2. 根据 [query-discover-events-in-table-format](https://docs.sentry.io/api/discover/query-discover-events-in-table-format/) 获取该 project 的聚合数据，**注意，API 内 project 模块提供的是未聚合的详情数据**
3. 根据 team 聚合每个 project 数据，得到结果

我们通过接口获取的 `events = transactions + errors + csp + default`，**并不包含 sessions** 数据计量

## Relay Server

[relay](https://github.com/getsentry/relay) 基于 Rust 开发，自己部署时更建议直接拉取其二进制包，这里介绍如何进行本地开发/部署。

### 环境准备

1. 依赖 rust 环境，[安装 rust](https://learnku.com/rust/wikis/29018)
2. `brew install cmake`，安装 cmake，CMake 是一个比 make 更高级的跨平台的安装、编译、配置工具
3. `brew install java`，安装 java 执行环境
4. `brew install kafka` 和 `brew install zookeeper` 部署 kafka 服务
5. `brew install redis` 部署 redis 服务

环境配置相关均可利用 docker 来完成，如果在本地跑过 Sentry 服务，则有些服务已经具备！

### 初始化

观察 `Makefile`，这里梳理本地 run 的流程：

`relay-generate` 内依赖 [uap-core](https://github.com/ua-parser/uap-core)，以 submodule 的形式进行引入，因此需要执行 `make setup` 来初始化依赖，

- 如果碰到 `pip command not found` 的问题，查看本地的 pip 映射目录，我通过将 Makefile 内的 pip 替换成 pip3 解决
- 碰到 `couldn't read relay-general/src/../uap-core/regexes.yaml: No such file or directory` 直接手动文件拷贝到 `/relay-general/uap-core` 目录下即可

执行 `make test` 检查 rust, python 以及 integration 的编译和测试用例情况

执行 `cargo run --all-features -- config init` 初始化 Relay 服务

执行 `cargo run --all-features -- run` 启动本地服务

验证服务是否启动:

- `host:port/api/relay/healthcheck/live/` 查看服务是否存活
- `host:port/api/relay/healthcheck/ready/` 上行服务权限验证是否正常

执行 `relay --help` 来查看 relay 服务

### 生成配置文件

通过 `relay config init` 创建一个初始配置，之后将配置文件放在 `.relay` 内

通过修改 `.relay/config.yml` 文件可以覆盖默认配置，下面是用来测试本地 sentry devserver 的配置

```yaml
---
relay:
  mode: proxy
  # upstream: 'https://sentry.io/'
  upstream: 'http://127.0.0.1:8000/'
  host: 127.0.0.1
  port: 7277
logging:
  # level: info
  level: trace
  enable_backtraces: true
  format: json
limits:
  max_thread_count: 8
# This should only be specified when compiling Relay as Sentry service
processing:
  enabled: true
  kafka_config:
    - { name: 'bootstrap.servers', value: '127.0.0.1:9092' }
    - { name: 'message.max.bytes', value: 2097176 }
  redis: 'redis://127.0.0.1'
```

之后，执行 `relay --config [config dir path]` 来启动服务，并指定配置目录路径，配置目录包括：

- **config.yml**
- **credentials.json**

### 创建证书

在 `.relay/credentials.json` 内读取公钥和私钥，用来验证上游服务器，配置 relay 的 `managed` 模式使用

通过也可以将 public key 用来在 sentry web 上注册 relay，用来覆盖默认配置，relay 服务会读取 Sentry 相关配置，比如：PII stripping, filtering, rate limiting 等等

相关命令：

- `relay credentials generate` 创建证书，证书会在 relay 的工作目录下
- `relay credentials show` 展示证书

### mode

在 Sentry 内，事件的处理是通过事件配置来进行控制的，事件配置来源可以是 project 和 organization，并且 organization 的配置会被 project 继承，realy 会执行一个定时任务来拉取配置，从而根据配置来处理事件

Relay 的模式用来控制 relay 服务获取各个项目的事件配置的方式，支持三种模式：managed, static 和 proxy

- `managed` 表示从 Sentry.io 的主服务内拉取配置，如果拉去不到 project 配置或者权限验证不通过，事件都会被丢弃
- `static` 表示项目配置需要手动配置，并且只会处理配置的项目，其他没有配置的项目，其事件都不会被处理
- `proxy` 和 static 模式类似，但是对于未知的项目，它依然会转发事件
