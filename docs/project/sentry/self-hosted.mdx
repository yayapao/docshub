---
id: self_hosted
title: 私有化部署
sidebar_label: self hosted
---

import { HighlightWithText } from '/src/components/Highlights'

对于开源项目，出于数据安全和功能拓展的考虑，我们一般会选择私有化部署。在本章节，我们将讨论私有化部署 Sentry 的解决方案。

## 官方解决方案

参考[官方推荐私有化部署](https://github.com/getsentry/self-hosted)，它是将 Sentry 依赖的各个服务挂载到 Docker 上，通过 Docker-compose 来统一管理

系统要求：
- Docker 19.03.6+ 
- Compose 1.28.0+
- 4 CPU Cores
- 8 GB RAM
- 20 GB Free Disk Space
- MacOS

部署流程参考官方文档即可。官方推荐的私有化方式能够快速部署上线，但是由于整个服务部署在单机上，无法灵活地扩容，性能瓶颈十分明显。因此在实际生产中，我们并没有直接采纳该方案，而是将其各个服务拆解出来，独立部署。

:::info why this way works?
因为 sentry 本身基于 redis、Kafka 和 CK 等数据服务来进行事件流的通信和处理，业务服务之间并未直接依赖
:::


## 环境准备

现在目标很明确：在测试环境（本地）将 Sentry 各个服务跑起来，之后将各个服务拆开，进而部署到生产环境。

参考[官方文档-Environment](https://develop.sentry.dev/environment/) 部署运行时环境并且安装依赖。

### 运行时依赖

<HighlightWithText text="源码"/> 

- [clone sentry](https://github.com/getsentry/sentry) **建议选择最新的稳定 release 版本**

<HighlightWithText text="基础环境准备 - MacOS"/> 

- 执行 `xcode-select --install` 或者启动 Xcode 更新 Xcode CLI tools，目的是安装 MacOS 的基础开发环境
- 进入 sentry 本地目录，执行 `brew bundle --verbose` 安装在 Brewfile 内列出的各种软件

<HighlightWithText text="Python 依赖"/> 

:::caution
**⚠️ 一定要主要重启控制台！**
:::

Sentry 依赖 [python wheels](https://pythonwheels.com/)，它包含一些二进制包，需要保证 MacOS 版本较新且本机内安装有 Rust 执行环境

Sentry 利用 [pyenv](https://github.com/pyenv/pyenv) 来安装和管理 python 版本，执行 `brew install pyenv` 安装一下，之后执行 `make setup-pyenv` 安装 Sentry 依赖环境
  - 安装完成之后，执行 `which python` --> 预期出现 `/usr/bin/python`
  - 修改 `bash_profile`，添加 `#pyenv \n eval "$(pyenv init -)" \n export PATH="$HOME/.pyenv/bin:$PATH"` 来指定路径
  - 执行 `eval "$SHELL"` 重启控制台 
  - 再次执行 `which python` --> 预期出现 `/Users/you/.pyenv/shims/python`，相当于做了一次拦截，将 python 命令托管给 pyenv 后统一处理
  - 在 sentry 根目录下，执行 `python -m venv .venv` 创建 python 项目虚拟执行路径
  - `source .venv/bin/activate` 启用运行环境
  - 此时在虚拟环境内执行 `which python` --> 预期出现 `/Users/you/sentry/.venv/bin/python`

<HighlightWithText text="Node.js 依赖"/> 

Sentry 依赖 [volta](https://github.com/volta-cli/volta) 来安装和管理 Node.js 版本
  - 执行 `curl https://get.volta.sh | bash` 来 install volta
  - 执行 `eval "$SHELL"` 重启控制台
  - 修改 `bash_profile`，添加 `export VOLTA_HOME="$HOME/.volta" \n export PATH="$VOLTA_HOME/bin:$PATH"`

<HighlightWithText text="管理环境变量"/> 

- Sentry 依赖 [direnv](https://github.com/direnv/direnv) 来自动激活你的虚拟环境，设置一些必要的环境变量，并且会自动检测你的环境是否可用
  - 执行 `brew install direnv` ，之后在 `.zshrc` 文件末尾添加配置 `eval "$(direnv hook zsh)"`
  - 执行 `eval "$SHELL"` 重启控制台

## 启动项目

执行 `make bootstrap` 来启动项目，在 Docker Dashboard 内观察 Sentry 服务的运行情况，理论上会启动：

- `sentry_relay` （会在每次启动 sentry 服务时，自动启动一个 relay 服务）
- `sentry_snuba`
- `sentry_kafka`
- `sentry_zookeeper`
- `sentry_postgres`
- `sentry_redis`
- `sentry_clickhouse`

### 运行 Sentry

:::caution --workers
如果需要走通 sentry 上报的全部流程(即启动所有服务)，需要执行 `sentry devserver --workers`
:::

在本地仓库内，重点观察 `Makfile`, `setup.py` 文件，下面介绍运行命令：

- 执行 `make bootstrap` 在 docker 内启动服务
- 执行 `sentry help` 查看相关命令

### 打包构建

这里我们参考源仓库的 `/docker/builder.*` 文件来查看构建流程，基于此，我们开发了一个构建脚本。

最终效果会在 dist 目录下生成构建产物
- **requirements.txt** 用来表示需要安装的依赖
- **sentry-[sentry version]-[python version]-none-any.whl** 打包文件


## Relay

:::note
The Sentry Relay is a service that pushes some functionality from the Sentry SDKs as well as the Sentry server into a proxy process.
:::

Relay Server 是一个运行在应用和 Sentry.io 之间的独立中间层服务，它被设计能够清洗用户信息和提高响应速度，它是事件上报的入口，承担 Event Ingestion 的工作。

这里我们从源码编译和构建镜像两方面介绍如何在容器内部署 realy 服务。

### 源码编译

这一步我们目的是获取 relay 的可执行文件、配置文件、必须物料

我们获取构建产物的途径：
- 根据 [relay 源码](https://github.com/getsentry/relay) 打包
- [dockerhub](https://hub.docker.com/r/getsentry/relay) 内获取

#### 通过 docker container 获取（👍）

思路：下载官方镜像，在本地容器内启动之后，通过 `docker cp` 将其拷贝到本地；上传到存储服务后，每次构建拉取文件即可。

具体步骤：
1. 参考 Dockerfile.relay.local 编写 Dockerfile；
2. 构建本地镜像

```bash
RELAY_VERSION=22.7.0
docker build -f Dockerfile.relay.local -t relay:$RELAY_VERSION --build-arg RELAY_VERSION .
```

3. 测试 relay cli 能否正常启动

```bash
docker run --rm -it -v [absolute config path]:/etc/opt/relay relay:$RELAY_VERSION --help
```

4. 运行一个实例，通过 `-v` 将 `/etc/opt/relay` 映射到本地 volumn，并设置 `processing enable: false`，**注意：我们的目的只是将容器跑起来**

```yml
---
relay:
  upstream: 'http://host.docker.internal:8000/'
  host: 0.0.0.0
  port: 3000
logging:
  level: TRACE
  enable_backtraces: true
  format: json
limits:
  shutdown_timeout: 100000
processing:
  enabled: false
```

5. 执行 `docker cp [container id]:[path] [local host path]` 将容器内文件拷贝至本地，需要拷贝文件包括：
- **/usr/local/bin/relay** relay 的二进制文件
- **/opt/relay/relay.src.zip**
- **/opt/relay/relay-debug.zip**


#### 源码打包

我们参考 [relay Dockfile](https://github.com/getsentry/relay/blob/master/Dockerfile) 来编写具体步骤。

#### 配置文件

配置文件包括：
- **config.yml**
- **credentials.json**

`config.yml` 根据实际情况配置即可。

`credentials.json` 需要在本地/容器内，通过 `relay credentials generate` 生成后进行保存即可。

#### 其他必须物料

必须物料：
- **GeoLite2-City.mmdb** 直接在仓库内下载即可，用来指定地理位置文件路径

```yml
processing:
  enabled: true
  geoip_path: "/var/cache/geoip/GeoLite2-City.mmdb"
```

### 构建镜像

我们参考 [relay Dockfile](https://github.com/getsentry/relay/blob/master/Dockerfile) 来编写具体步骤。

- 安装环境依赖、工具
- 拉取 relay 文件，即构建产物
- 启动 relay 服务

相关 Dockerfile 参考 [Dockerfile.relay.start]


