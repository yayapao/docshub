---
id: self_hosted
title: ç§æœ‰åŒ–éƒ¨ç½²
sidebar_label: self hosted
---

import { HighlightWithText } from '/src/components/Highlights'

å¯¹äºå¼€æºé¡¹ç›®ï¼Œå‡ºäºæ•°æ®å®‰å…¨å’ŒåŠŸèƒ½æ‹“å±•çš„è€ƒè™‘ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€‰æ‹©ç§æœ‰åŒ–éƒ¨ç½²ã€‚åœ¨æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬å°†è®¨è®ºç§æœ‰åŒ–éƒ¨ç½² Sentry çš„è§£å†³æ–¹æ¡ˆã€‚

## å®˜æ–¹è§£å†³æ–¹æ¡ˆ

å‚è€ƒ[å®˜æ–¹æ¨èç§æœ‰åŒ–éƒ¨ç½²](https://github.com/getsentry/self-hosted)ï¼Œå®ƒæ˜¯å°† Sentry ä¾èµ–çš„å„ä¸ªæœåŠ¡æŒ‚è½½åˆ° Docker ä¸Šï¼Œé€šè¿‡ Docker-compose æ¥ç»Ÿä¸€ç®¡ç†

ç³»ç»Ÿè¦æ±‚ï¼š
- Docker 19.03.6+ 
- Compose 1.28.0+
- 4 CPU Cores
- 8 GB RAM
- 20 GB Free Disk Space
- MacOS

éƒ¨ç½²æµç¨‹å‚è€ƒå®˜æ–¹æ–‡æ¡£å³å¯ã€‚å®˜æ–¹æ¨èçš„ç§æœ‰åŒ–æ–¹å¼èƒ½å¤Ÿå¿«é€Ÿéƒ¨ç½²ä¸Šçº¿ï¼Œä½†æ˜¯ç”±äºæ•´ä¸ªæœåŠ¡éƒ¨ç½²åœ¨å•æœºä¸Šï¼Œæ— æ³•çµæ´»åœ°æ‰©å®¹ï¼Œæ€§èƒ½ç“¶é¢ˆååˆ†æ˜æ˜¾ã€‚å› æ­¤åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç›´æ¥é‡‡çº³è¯¥æ–¹æ¡ˆï¼Œè€Œæ˜¯å°†å…¶å„ä¸ªæœåŠ¡æ‹†è§£å‡ºæ¥ï¼Œç‹¬ç«‹éƒ¨ç½²ã€‚

:::info why this way works?
å› ä¸º sentry æœ¬èº«åŸºäº redisã€Kafka å’Œ CK ç­‰æ•°æ®æœåŠ¡æ¥è¿›è¡Œäº‹ä»¶æµçš„é€šä¿¡å’Œå¤„ç†ï¼Œä¸šåŠ¡æœåŠ¡ä¹‹é—´å¹¶æœªç›´æ¥ä¾èµ–
:::


## ç¯å¢ƒå‡†å¤‡

ç°åœ¨ç›®æ ‡å¾ˆæ˜ç¡®ï¼šåœ¨æµ‹è¯•ç¯å¢ƒï¼ˆæœ¬åœ°ï¼‰å°† Sentry å„ä¸ªæœåŠ¡è·‘èµ·æ¥ï¼Œä¹‹åå°†å„ä¸ªæœåŠ¡æ‹†å¼€ï¼Œè¿›è€Œéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

å‚è€ƒ[å®˜æ–¹æ–‡æ¡£-Environment](https://develop.sentry.dev/environment/) éƒ¨ç½²è¿è¡Œæ—¶ç¯å¢ƒå¹¶ä¸”å®‰è£…ä¾èµ–ã€‚

### è¿è¡Œæ—¶ä¾èµ–

<HighlightWithText text="æºç "/> 

- [clone sentry](https://github.com/getsentry/sentry) **å»ºè®®é€‰æ‹©æœ€æ–°çš„ç¨³å®š release ç‰ˆæœ¬**

<HighlightWithText text="åŸºç¡€ç¯å¢ƒå‡†å¤‡ - MacOS"/> 

- æ‰§è¡Œ `xcode-select --install` æˆ–è€…å¯åŠ¨ Xcode æ›´æ–° Xcode CLI toolsï¼Œç›®çš„æ˜¯å®‰è£… MacOS çš„åŸºç¡€å¼€å‘ç¯å¢ƒ
- è¿›å…¥ sentry æœ¬åœ°ç›®å½•ï¼Œæ‰§è¡Œ `brew bundle --verbose` å®‰è£…åœ¨ Brewfile å†…åˆ—å‡ºçš„å„ç§è½¯ä»¶

<HighlightWithText text="Python ä¾èµ–"/> 

:::caution
**âš ï¸ ä¸€å®šè¦ä¸»è¦é‡å¯æ§åˆ¶å°ï¼**
:::

Sentry ä¾èµ– [python wheels](https://pythonwheels.com/)ï¼Œå®ƒåŒ…å«ä¸€äº›äºŒè¿›åˆ¶åŒ…ï¼Œéœ€è¦ä¿è¯ MacOS ç‰ˆæœ¬è¾ƒæ–°ä¸”æœ¬æœºå†…å®‰è£…æœ‰ Rust æ‰§è¡Œç¯å¢ƒ

Sentry åˆ©ç”¨ [pyenv](https://github.com/pyenv/pyenv) æ¥å®‰è£…å’Œç®¡ç† python ç‰ˆæœ¬ï¼Œæ‰§è¡Œ `brew install pyenv` å®‰è£…ä¸€ä¸‹ï¼Œä¹‹åæ‰§è¡Œ `make setup-pyenv` å®‰è£… Sentry ä¾èµ–ç¯å¢ƒ
  - å®‰è£…å®Œæˆä¹‹åï¼Œæ‰§è¡Œ `which python` --> é¢„æœŸå‡ºç° `/usr/bin/python`
  - ä¿®æ”¹ `bash_profile`ï¼Œæ·»åŠ  `#pyenv \n eval "$(pyenv init -)" \n export PATH="$HOME/.pyenv/bin:$PATH"` æ¥æŒ‡å®šè·¯å¾„
  - æ‰§è¡Œ `eval "$SHELL"` é‡å¯æ§åˆ¶å° 
  - å†æ¬¡æ‰§è¡Œ `which python` --> é¢„æœŸå‡ºç° `/Users/you/.pyenv/shims/python`ï¼Œç›¸å½“äºåšäº†ä¸€æ¬¡æ‹¦æˆªï¼Œå°† python å‘½ä»¤æ‰˜ç®¡ç»™ pyenv åç»Ÿä¸€å¤„ç†
  - åœ¨ sentry æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ `python -m venv .venv` åˆ›å»º python é¡¹ç›®è™šæ‹Ÿæ‰§è¡Œè·¯å¾„
  - `source .venv/bin/activate` å¯ç”¨è¿è¡Œç¯å¢ƒ
  - æ­¤æ—¶åœ¨è™šæ‹Ÿç¯å¢ƒå†…æ‰§è¡Œ `which python` --> é¢„æœŸå‡ºç° `/Users/you/sentry/.venv/bin/python`

<HighlightWithText text="Node.js ä¾èµ–"/> 

Sentry ä¾èµ– [volta](https://github.com/volta-cli/volta) æ¥å®‰è£…å’Œç®¡ç† Node.js ç‰ˆæœ¬
  - æ‰§è¡Œ `curl https://get.volta.sh | bash` æ¥ install volta
  - æ‰§è¡Œ `eval "$SHELL"` é‡å¯æ§åˆ¶å°
  - ä¿®æ”¹ `bash_profile`ï¼Œæ·»åŠ  `export VOLTA_HOME="$HOME/.volta" \n export PATH="$VOLTA_HOME/bin:$PATH"`

<HighlightWithText text="ç®¡ç†ç¯å¢ƒå˜é‡"/> 

- Sentry ä¾èµ– [direnv](https://github.com/direnv/direnv) æ¥è‡ªåŠ¨æ¿€æ´»ä½ çš„è™šæ‹Ÿç¯å¢ƒï¼Œè®¾ç½®ä¸€äº›å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨æ£€æµ‹ä½ çš„ç¯å¢ƒæ˜¯å¦å¯ç”¨
  - æ‰§è¡Œ `brew install direnv` ï¼Œä¹‹ååœ¨ `.zshrc` æ–‡ä»¶æœ«å°¾æ·»åŠ é…ç½® `eval "$(direnv hook zsh)"`
  - æ‰§è¡Œ `eval "$SHELL"` é‡å¯æ§åˆ¶å°

## å¯åŠ¨é¡¹ç›®

æ‰§è¡Œ `make bootstrap` æ¥å¯åŠ¨é¡¹ç›®ï¼Œåœ¨ Docker Dashboard å†…è§‚å¯Ÿ Sentry æœåŠ¡çš„è¿è¡Œæƒ…å†µï¼Œç†è®ºä¸Šä¼šå¯åŠ¨ï¼š

- `sentry_relay` ï¼ˆä¼šåœ¨æ¯æ¬¡å¯åŠ¨ sentry æœåŠ¡æ—¶ï¼Œè‡ªåŠ¨å¯åŠ¨ä¸€ä¸ª relay æœåŠ¡ï¼‰
- `sentry_snuba`
- `sentry_kafka`
- `sentry_zookeeper`
- `sentry_postgres`
- `sentry_redis`
- `sentry_clickhouse`

### è¿è¡Œ Sentry

:::caution --workers
å¦‚æœéœ€è¦èµ°é€š sentry ä¸ŠæŠ¥çš„å…¨éƒ¨æµç¨‹(å³å¯åŠ¨æ‰€æœ‰æœåŠ¡)ï¼Œéœ€è¦æ‰§è¡Œ `sentry devserver --workers`
:::

åœ¨æœ¬åœ°ä»“åº“å†…ï¼Œé‡ç‚¹è§‚å¯Ÿ `Makfile`, `setup.py` æ–‡ä»¶ï¼Œä¸‹é¢ä»‹ç»è¿è¡Œå‘½ä»¤ï¼š

- æ‰§è¡Œ `make bootstrap` åœ¨ docker å†…å¯åŠ¨æœåŠ¡
- æ‰§è¡Œ `sentry help` æŸ¥çœ‹ç›¸å…³å‘½ä»¤

### æ‰“åŒ…æ„å»º

è¿™é‡Œæˆ‘ä»¬å‚è€ƒæºä»“åº“çš„ `/docker/builder.*` æ–‡ä»¶æ¥æŸ¥çœ‹æ„å»ºæµç¨‹ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªæ„å»ºè„šæœ¬ã€‚

æœ€ç»ˆæ•ˆæœä¼šåœ¨ dist ç›®å½•ä¸‹ç”Ÿæˆæ„å»ºäº§ç‰©
- **requirements.txt** ç”¨æ¥è¡¨ç¤ºéœ€è¦å®‰è£…çš„ä¾èµ–
- **sentry-[sentry version]-[python version]-none-any.whl** æ‰“åŒ…æ–‡ä»¶


## Relay

:::note
The Sentry Relay is a service that pushes some functionality from the Sentry SDKs as well as the Sentry server into a proxy process.
:::

Relay Server æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨åº”ç”¨å’Œ Sentry.io ä¹‹é—´çš„ç‹¬ç«‹ä¸­é—´å±‚æœåŠ¡ï¼Œå®ƒè¢«è®¾è®¡èƒ½å¤Ÿæ¸…æ´—ç”¨æˆ·ä¿¡æ¯å’Œæé«˜å“åº”é€Ÿåº¦ï¼Œå®ƒæ˜¯äº‹ä»¶ä¸ŠæŠ¥çš„å…¥å£ï¼Œæ‰¿æ‹… Event Ingestion çš„å·¥ä½œã€‚

è¿™é‡Œæˆ‘ä»¬ä»æºç ç¼–è¯‘å’Œæ„å»ºé•œåƒä¸¤æ–¹é¢ä»‹ç»å¦‚ä½•åœ¨å®¹å™¨å†…éƒ¨ç½² realy æœåŠ¡ã€‚

### æºç ç¼–è¯‘

è¿™ä¸€æ­¥æˆ‘ä»¬ç›®çš„æ˜¯è·å– relay çš„å¯æ‰§è¡Œæ–‡ä»¶ã€é…ç½®æ–‡ä»¶ã€å¿…é¡»ç‰©æ–™

æˆ‘ä»¬è·å–æ„å»ºäº§ç‰©çš„é€”å¾„ï¼š
- æ ¹æ® [relay æºç ](https://github.com/getsentry/relay) æ‰“åŒ…
- [dockerhub](https://hub.docker.com/r/getsentry/relay) å†…è·å–

#### é€šè¿‡ docker container è·å–ï¼ˆğŸ‘ï¼‰

æ€è·¯ï¼šä¸‹è½½å®˜æ–¹é•œåƒï¼Œåœ¨æœ¬åœ°å®¹å™¨å†…å¯åŠ¨ä¹‹åï¼Œé€šè¿‡ `docker cp` å°†å…¶æ‹·è´åˆ°æœ¬åœ°ï¼›ä¸Šä¼ åˆ°å­˜å‚¨æœåŠ¡åï¼Œæ¯æ¬¡æ„å»ºæ‹‰å–æ–‡ä»¶å³å¯ã€‚

å…·ä½“æ­¥éª¤ï¼š
1. å‚è€ƒ Dockerfile.relay.local ç¼–å†™ Dockerfileï¼›
2. æ„å»ºæœ¬åœ°é•œåƒ

```bash
RELAY_VERSION=22.7.0
docker build -f Dockerfile.relay.local -t relay:$RELAY_VERSION --build-arg RELAY_VERSION .
```

3. æµ‹è¯• relay cli èƒ½å¦æ­£å¸¸å¯åŠ¨

```bash
docker run --rm -it -v [absolute config path]:/etc/opt/relay relay:$RELAY_VERSION --help
```

4. è¿è¡Œä¸€ä¸ªå®ä¾‹ï¼Œé€šè¿‡ `-v` å°† `/etc/opt/relay` æ˜ å°„åˆ°æœ¬åœ° volumnï¼Œå¹¶è®¾ç½® `processing enable: false`ï¼Œ**æ³¨æ„ï¼šæˆ‘ä»¬çš„ç›®çš„åªæ˜¯å°†å®¹å™¨è·‘èµ·æ¥**

```yml
---
relay:
  upstream: 'http://host.docker.internal:8000/'
  host: 0.0.0.0
  port: 3000
logging:
  level: TRACE
  enable_backtraces: true
  format: json
limits:
  shutdown_timeout: 100000
processing:
  enabled: false
```

5. æ‰§è¡Œ `docker cp [container id]:[path] [local host path]` å°†å®¹å™¨å†…æ–‡ä»¶æ‹·è´è‡³æœ¬åœ°ï¼Œéœ€è¦æ‹·è´æ–‡ä»¶åŒ…æ‹¬ï¼š
- **/usr/local/bin/relay** relay çš„äºŒè¿›åˆ¶æ–‡ä»¶
- **/opt/relay/relay.src.zip**
- **/opt/relay/relay-debug.zip**


#### æºç æ‰“åŒ…

æˆ‘ä»¬å‚è€ƒ [relay Dockfile](https://github.com/getsentry/relay/blob/master/Dockerfile) æ¥ç¼–å†™å…·ä½“æ­¥éª¤ã€‚

#### é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶åŒ…æ‹¬ï¼š
- **config.yml**
- **credentials.json**

`config.yml` æ ¹æ®å®é™…æƒ…å†µé…ç½®å³å¯ã€‚

`credentials.json` éœ€è¦åœ¨æœ¬åœ°/å®¹å™¨å†…ï¼Œé€šè¿‡ `relay credentials generate` ç”Ÿæˆåè¿›è¡Œä¿å­˜å³å¯ã€‚

#### å…¶ä»–å¿…é¡»ç‰©æ–™

å¿…é¡»ç‰©æ–™ï¼š
- **GeoLite2-City.mmdb** ç›´æ¥åœ¨ä»“åº“å†…ä¸‹è½½å³å¯ï¼Œç”¨æ¥æŒ‡å®šåœ°ç†ä½ç½®æ–‡ä»¶è·¯å¾„

```yml
processing:
  enabled: true
  geoip_path: "/var/cache/geoip/GeoLite2-City.mmdb"
```

### æ„å»ºé•œåƒ

æˆ‘ä»¬å‚è€ƒ [relay Dockfile](https://github.com/getsentry/relay/blob/master/Dockerfile) æ¥ç¼–å†™å…·ä½“æ­¥éª¤ã€‚

- å®‰è£…ç¯å¢ƒä¾èµ–ã€å·¥å…·
- æ‹‰å– relay æ–‡ä»¶ï¼Œå³æ„å»ºäº§ç‰©
- å¯åŠ¨ relay æœåŠ¡

ç›¸å…³ Dockerfile å‚è€ƒ [Dockerfile.relay.start]


