---
id: structure
title: ''
sidebar_label: Structure
---

import { DocsHeader } from '/src/components/Layout/DocsHeader'
import {
  HighlightWithCode,
  HighlightWithText,
} from '/src/components/Highlights/TextContent'
import { ResolvedTag } from '/src/components/Highlights/CustomizedTag'

<DocsHeader
  title="Sentry Structure"
  description="Sentry server & SDK structure."
  tags={['structure']}
  links={[
    {
      label: `Snuba Structure`,
      link: 'https://getsentry.github.io/snuba/architecture/overview.html',
    },
    {
      label: `Sentry: Event Ingestion Pipeline`,
      link: 'https://getsentry.github.io/event-ingestion-graph/',
    },
    {
      label: 'å•ä½“ç³»ç»Ÿæ—¶ä»£',
      link: 'http://icyfenix.cn/architecture/architect-history/monolithic.html',
    },
  ]}
/>{' '}

## Background

é€šè¿‡å¯¹ Sentry æ¶æ„è¿›è¡Œæ·±å…¥ç ”ç©¶ï¼Œå……åˆ†åˆ©ç”¨å…¶åŸºäºé˜Ÿåˆ—çš„è®¾è®¡æ¨¡å¼ï¼Œå¯¹æœåŠ¡ã€worker å‡è¿›è¡Œç»†è‡´æ‹†åˆ†ï¼Œè¾“å‡ºä¸€å¥—å¾®æœåŠ¡æ¶æ„çš„éƒ¨ç½²æ–¹æ¡ˆã€‚

åœ¨å¼€å§‹ä»‹ç»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆèŠèŠèƒŒæ™¯ã€‚

![sentry_structure_background](/img/fte/sentry/sentry_structure_background.png)

æ—§ç‰ˆæœ¬çš„ Sentry æ˜¯ä¸€ä¸ªå·¨çŸ³åº”ç”¨(Monolithic Application)ã€‚**å®ƒå¤©ç„¶å­˜åœ¨ç€éš”ç¦»å’Œè‡ªæ²»èƒ½åŠ›ä¸Šçš„ç¼ºé™·ï¼Œå¦‚æœä¸€éƒ¨åˆ†ä»£ç å¯¼è‡´è¿›ç¨‹èµ„æºè¢«è¿‡åº¦ä½¿ç”¨ï¼Œæœ€ç»ˆä¼šå½±å“åˆ°æ•´ä¸ªç¨‹åºã€‚** å› æ­¤ old sentry å­˜åœ¨ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆï¼ŒåŒæ—¶ä¸ºäº†èƒ½å¤Ÿ cover ä½ä¸šåŠ¡çš„é‡ï¼Œæˆ‘ä»¬ä¸å¾—ä¸å»éƒ¨ç½²å¤šå¥—ï¼Œä¸ºæ­¤é€ æˆäº†æ›´ä¸¥é‡çš„èµ„æºæµªè´¹ã€‚å¹¶ä¸”æˆ‘ä»¬å¯¹å¹³å°åŠŸèƒ½å®šåˆ¶ä¹Ÿæ— èƒ½ä¸ºåŠ› ğŸ‘ã€‚

:::tip Monilithic Apploication - wikipedia

Monolith means composed all in one piece. The Monolithic application describes a single-tiered software application in which different components combined into a single program from a single platform.

å•ä½“æ„å‘³ç€è‡ªåŒ…å«ã€‚å•ä½“åº”ç”¨æè¿°äº†ä¸€ç§ç”±åŒä¸€æŠ€æœ¯å¹³å°çš„ä¸åŒç»„ä»¶æ„æˆçš„å•å±‚è½¯ä»¶ã€‚

:::

ä¸ºæ­¤ï¼Œæˆ‘æå‡ºäº†å‡çº§è®¡åˆ’ã€‚ç»è¿‡è°ƒç ”æˆ‘å‘ç°ï¼Œåœ¨ Sentry ç¤¾åŒºå†…æä¾›äº† [self_hosted](https://github.com/getsentry/self-hosted) æ–¹æ¡ˆï¼Œ**å®ƒæœ€ç»ˆè¾“å‡º docker-composeã€‚**è¿™æ„å‘³ç€æˆ‘ä¸å¾—ä¸å»ç”³è¯·ä¸€ä¸ªé«˜è§„æ ¼çš„ pod å°†æ‰€æœ‰æœåŠ¡è·‘èµ·æ¥ï¼Œæ ¹æ®æµ‹è¯•åœ¨ 42C128G çš„æƒ…å†µä¸‹ï¼ŒQPS è¾¾åˆ° 30 æœåŠ¡å°±æ— æ³•æ­£å¸¸è¿è¡Œäº†ï¼Œè¿™æ˜¾ç„¶æ— æ³•æ»¡è¶³éœ€æ±‚ï¼ŒåŒæ—¶å…¶è¡¨ç°ä¸ºä¸€ä¸ªç±»å·¨çŸ³åº”ç”¨ï¼Œå¹¶æ²¡æœ‰è§£å†³ old sentry çš„é—ç•™é—®é¢˜ã€‚

## Microservices Structure

ä¸ºæ­¤ï¼Œé€šè¿‡å¯¹ Sentry æ¶æ„è¿›è¡Œæ·±å…¥ç ”ç©¶å’Œç†è§£ï¼Œæˆ‘æå‡ºäº†ä¸€å¥—å¾®æœåŠ¡æ¶æ„çš„éƒ¨ç½²æ–¹æ¡ˆã€‚**å·¨çŸ³åº”ç”¨å’Œå¾®æœåŠ¡æ¶æ„æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå·¨çŸ³åº”ç”¨æ˜¯è¿›ç¨‹å†…è°ƒç”¨ï¼Œè€Œå¾®æœåŠ¡æ¶æ„æ˜¯è¿›ç¨‹é—´é€šä¿¡ã€‚**è¿™é‡Œæˆ‘åˆ©ç”¨å…¶åŸºäºé˜Ÿåˆ—çš„è®¾è®¡æ¨¡å¼ï¼Œå°†æœåŠ¡è¿›è¡Œæ‹†åˆ†ï¼ŒåŒæ—¶å°† big worker æ‹†åˆ†æˆæ›´ç»†ç²’åº¦çš„ workerï¼Œworker ä¹‹é—´åŸºäº celery è¿›è¡Œé€šä¿¡ã€‚

## Relay

åœ¨ Sentry æ¶æ„ä¸­ï¼Œrelay æ‰®æ¼”ä»£ç†æœåŠ¡çš„è§’è‰²ï¼ˆæˆ–è€… Sentry åŸºç¡€è®¾æ–½ï¼‰ï¼Œå®ƒå¯¹ client ä¸ŠæŠ¥æ•°æ®è¿›è¡Œåº”ç­”ï¼ŒåŒæ—¶å‘ Sentry è¯·æ±‚é¡¹ç›®é…ç½®ï¼Œä»¥å¯¹ event æ‰§è¡Œ parseã€normalizedã€inbound filtersã€rate limitsã€datascrubã€PII ç­‰å¤„ç†ï¼Œæœ€ç»ˆå°†äº‹ä»¶å†™å…¥ kafkaã€‚

![sentry_relay_diagram](/img/fte/sentry/sentry_relay_diagram.png)

è¿™é‡Œå±•ç¤º relay å¤„ç†äº‹ä»¶çš„å†…éƒ¨æ—¶åºå›¾ã€‚

:::warning

In a highly concurrent burst of requests should quickly result in eventually consistent and correct status codes.

**åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œåº”è¯¥è¿…é€Ÿè¿”å›ä¸€è‡´ä¸”æ­£ç¡®çš„çŠ¶æ€ç ï¼ˆå³ 200ï¼‰**

:::

æŒ‰ç…§æ­¤åŸåˆ™ï¼Œå¯èƒ½å‡ºç°æˆ‘ä»¬è¿”å› 200ï¼Œä½†æ˜¯äº‹ä»¶æœ€ç»ˆæ²¡æœ‰è¢«å¤„ç†çš„æƒ…å†µï¼Œå› ä¸ºçœŸæ­£å¼€å§‹å¤„ç†äº‹ä»¶æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ç§åœ¨è¿”å›é€Ÿç‡å’Œæ•°æ®å‡†ç¡®ç‡ä¹‹é—´çš„å¦¥åã€‚

1. å½“è¯·æ±‚åˆ°è¾¾ relay endpoint æ—¶ï¼Œä¼š**æ‰§è¡Œé¢„æ£€æŸ¥ç­–ç•¥**ï¼Œå¦‚æœç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œåˆ™è¿…é€Ÿè¿”å› 4xx(429-rate_limit, 4xx-invalid_auth_information)ï¼Œå¦åˆ™ä¼šå°†äº‹ä»¶æäº¤ç»™ Redis é˜Ÿåˆ—ã€‚åœ¨æ­¤è¿‡ç¨‹ä¼šä¸»åŠ¨ä» ProjectCache å†…æ‹‰å–é¡¹ç›®é…ç½®ã€‚

**æ³¨æ„ï¼Œæ­¤æ—¶æ‹‰å»ä¸åˆ°é¡¹ç›®é…ç½®æˆ–è€…é…ç½®è¿‡æœŸï¼Œå¹¶ä¸ä¼šç»§ç»­å‘ Sentry å‘é€è¯·æ±‚ï¼Œè€Œæ˜¯è®¤ä¸ºäº‹ä»¶ä¸åˆæ³•ã€‚**

æ£€æŸ¥ç­–ç•¥åŒ…æ‹¬ï¼š

- å½“å‰é¡¹ç›®æ˜¯å¦å­˜åœ¨ï¼Ÿé¡¹ç›®æ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€ï¼Ÿ
- å½“å‰æ˜¯å¦æ­£åœ¨æ‰§è¡Œé€Ÿç‡é™åˆ¶ï¼Ÿ
- é¡¹ç›®çš„ DSN æ˜¯å¦æ­£ç¡®ï¼Ÿ

2. EnvelopeManager é€šè¿‡ Redis é˜Ÿåˆ—æ¶ˆè´¹æ•°æ®ï¼Œè§£æåè¿”å› 200ï¼ˆæºå¸¦ EventIDï¼‰ï¼Œéšåå¼€å§‹çœŸæ­£å¤„ç†äº‹ä»¶ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥å¤„ç†è¿‡ç¨‹ï¼ï¼‰

- EnvelopeManager ä¼šå‘ ProjectCache ä¸»åŠ¨æ‹‰å–é¡¹ç›®é…ç½®ã€‚**å¦‚æœé¡¹ç›®é…ç½®è¢«æ¸…é™¤æˆ–è€…è¿‡æœŸï¼ŒRelay ä¼šå‘ Sentry å‘é€è·å–é¡¹ç›®é…ç½®è¯·æ±‚ï¼Œå¹¶å°½å¯èƒ½ä¸€æ¬¡æ‹‰å–å¤šä¸ªé¡¹ç›®çš„é…ç½®ï¼Œä»¥å‡å°‘ Sentry æœåŠ¡çš„å‹åŠ›ï¼›**
- è§£æäº‹ä»¶ï¼Œå¯¹æ•°æ®è¿›è¡Œè§£å‹ç¼©ã€æ£€æŸ¥ json åˆæ³•æ€§ã€æå–äº‹ä»¶å†…çš„ eventID å¹¶å°†å…¶å†™å…¥ responseã€‚**è¿™é‡Œ relay å·²ç»åˆ›å»ºäº† `Event` ç»“æ„ä½“ï¼Œè¿™ä¸€æ­¥éœ€è¦ç”³è¯·å†…å­˜ï¼›**
- äº‹ä»¶æ ‡å‡†åŒ–å¤„ç†ã€‚ä¸º Event ç»“æ„ä½“èµ‹å€¼ï¼Œè¿™æ˜¯ relay ä¸­æœ€æ¶ˆè€— CPU ç®—åŠ›çš„ä¸€ä¸ªä»»åŠ¡å•å…ƒï¼Œæ­¤æ—¶ä¼šä¸¢å¼ƒä¸åˆæ³•çš„æ•°æ®ï¼›
- è¿‡æ»¤äº‹ä»¶ï¼ˆinbound-filterï¼‰ï¼Œåœ¨è¿™ä¸€æ­¥ä¼šåº”ç”¨é…ç½®çš„è¿‡æ»¤è§„åˆ™ï¼Œæ¯”å¦‚ IP addresses, partterns ç­‰ã€‚è¢«è¿‡æ»¤çš„äº‹ä»¶ä¼šè¢«ä¸¢å¼ƒï¼›
- é€Ÿç‡é™åˆ¶ã€‚è¿™é‡Œæ‰€è¯´çš„é€Ÿç‡é™åˆ¶æ˜¯æŒ‡ï¼Œä¸ºæ¯ä¸€ä¸ªé¡¹ç›®å»ºç«‹é…é¢ï¼ˆ_quatos_ï¼‰ï¼Œå¦‚æœè¶…è¿‡é™é¢åˆ™ä¼šå°†é…ç½®å†™å…¥å†…å­˜ä¸­ï¼Œä»¥é¿å…è¯¥é¡¹ç›®çš„æ–°å¢äº‹ä»¶è¢«å†™å…¥ redis é˜Ÿåˆ—ï¼Œ**é…é¢é€šå¸¸å‘ç”Ÿåœ¨ Sentry sass å¹³å°ä¸Šï¼›**
- æ¸…æ´—æ•°æ®ã€‚æ ¹æ® PII å’Œ datascrubbing config å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼›

3. å°†äº‹ä»¶å†™å…¥ Kafkaï¼Œå†™å…¥ `outcomes` å’Œ `ingest-event` topic ä¾› Sentry consumer æ¶ˆè´¹ï¼Œå…¶ä¸­ outcomes è¢«å¤„ç†åæœ€ç»ˆè¢« snuba æ¶ˆè´¹å¹¶å†™å…¥ TSDBã€‚

- outcomes ä¸»è¦å¯¹ Sentry å†…çš„è®¡æ•°å™¨è´Ÿè´£ï¼Œç”¨æ¥è¡¨è¾¾æ¯ä¸ªäº‹ä»¶çš„å¤„ç†ç»“æœï¼Œä»¥åŠä¸æ˜¯æ­£å¸¸å¤„ç†çš„åŸå› ï¼Œå‚è€ƒ [category åœ¨ relay å†…å®šä¹‰](https://github.com/getsentry/relay/blob/master/relay-common/src/constants.rs#:~:text=pub%20enum%20DataCategory,%7D)

**outcomes æ•°æ®ç»“æ„**

```json

{
    "timestamp": timestamp,
    "org_id": org_id,
    "project_id": project_id,
    "key_id": key_id,
    "outcome": outcome.value, // äº‹ä»¶å¤„ç†ç»“æœ
    "reason": reason,
    "event_id": event_id,
    "category": category, // äº‹ä»¶ç±»å‹
    "quantity": quantity,
}

```

**outcomes ç»“æœ**

```py

class Outcome(IntEnum):
    ACCEPTED = 0
    FILTERED = 1
    RATE_LIMITED = 2
    INVALID = 3
    ABUSE = 4
    CLIENT_DISCARD = 5

```
