---
id: husky
title: Use Husky
sidebar_label: Husky
---

import { HighlightWithCode } from '../../../src/components/Highlights'

:::info Husky
Modern native git hooks made easy!
:::

[Husky](https://typicode.github.io/husky/#/?) 能够让我们在项目内轻松使用 [githooks](https://git-scm.com/docs/githooks)

介入 git 生命周期之后，我们可以对团队统一规范做出贡献，比如格式化代码、统一提交信息、执行测试脚本、检测敏感信息等等

这里以 pnpm 为例进行记录安装过程：

```shell
# 1. 引入 husky
pnpm add husky -D

# 2. 启用 githooks
pnpx husky install

#3. 创建 githooks，下面代码相当于创建一个指定执行脚本的 commit-msg 钩子， 后续可以自己在 .husky 内进行修改
pnpx husky add .husky/commit-msg 'node scripts/verifyCommit.mjs'
```

## 规范 git commit message

**如何获取？**

在 commit-msg.sh 内，通过读取 `$1` 传参可以获取提交信息的保存路径，之后通过读取该路径的文件信息，获取提交信息，通常保存在 `./.git/COMMIT_EDITMSG` 

**如何验证？**

1. 获取提交信息；
2. 开发正则验证；
3. 验证不通过时，输出提示信息；

这里我们给一个例子，大家可以根据其进行扩展：

```javascript
// verifyCommit.mjs
const chalk = require('chalk')
const msgPath = require('path').resolve('./.git/COMMIT_EDITMSG')
const msg = require('fs')
  .readFileSync(msgPath, 'utf-8')
  .trim()

const commitRE = /^(revert: )?(feat)(\(.+\))?: .{1,50}/

if (!commitRE.test(msg)) {
  console.log()
  console.error(
    '  ' +
      chalk.bgRed.white(' ERROR ') +
      ' ' +
      chalk.red('invalid commit message format.') +
      '\n\n' +
      chalk.red(
        'Proper commit message format is required for automated changelog generation. Examples:\n\n',
      ) +
      '    \n    ' +
      chalk.green("\uD83D\uDCA5 feat(compiler): add 'comments' option")
  )
  process.exit(1)
}

```

一个规范的 commit 不仅能够帮助我们方便地生成 changelog，同时能够在 review 或者排查问题时提供便利！

## 结合 lint-staged 使用

[lint-staged](https://github.com/okonet/lint-staged) 是一个能够对 git 暂存区文件执行 shell 任务的工具，通常我们结合 lint 工具和 `pre-commmit` 钩子来使用。

我们在提交代码之前，进行 lint 检测和修正，能够阻止不规范的代码提交到仓库中，但是如果我们每次都对项目内所有文件进行 lint，整个流程会变得无比缓慢。而 lint-staged 通过对每次提交的增量文件进行扫描和修正，能够帮助我们解决上述问题。

:::caution
`lint-staged` 是本身不具备 format 的能力，你仍然需要安装 ESLint、Prettier 等代码格式化工具。
:::

首先，我们通过 husky 暴露 pre-commit：

```bash
pnpx husky add .husky/pre-commit 'pnpm run lint-staged'
```

在 `package.json` 内配置启动脚本（能够支持手动执行）：

```json
{
  "scripts": {
    "lint-staged": "lint-staged -c ./.husky/lintstagedrc.js"
  }
}
```

在 `./husky` 内创建 lint-staged 的执行配置，这里我们提供一个简单的参考：

```js
module.exports = {
  '*.{js,jsx,ts,tsx}': ['eslint --fix', 'prettier --write'],
  '{!(package)*.json,*.code-snippets,.!(browserslist)*rc}': ['prettier --write--parser json'],
  'package.json': ['prettier --write'],
  '*.vue': ['eslint --fix', 'prettier --write', 'stylelint --fix'],
  '*.{scss,less,styl,html}': ['stylelint --fix', 'prettier --write'],
  '*.md': ['prettier --write'],
};
```
