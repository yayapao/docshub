---
id: cloudServer
title: Cloud Server
sidebar_label: Cloud Server
slug: /cloudServer/
---

import { HighlightWithText } from '../../src/components/Highlights'

## Troubleshooting


<HighlightWithText>Q: 在服务器上拉取 github 的代码特别慢？</HighlightWithText>

<!-- -->

```
解决思路类似 Q2，通过配置 hosts 来指定 ip
通过 https://fastly.net.ipaddress.com/ 来查看：
1. github.com
2. github.global.ssl.fastly.net
的 ip 地址

之后将其添加到 hosts 文件内，最后执行 `sudo /etc/init.d/network restart` 刷新设置
```

## 初始化云服务的基础设施

这里以腾讯云 ubuntu 20.04 TLS 为例进行记录

### 设置 SSH 远程登录

参考:

- [使用远程登录软件登录 Linux 实例](https://cloud.tencent.com/document/product/1207/44578)
- [Ubuntu 系统如何使用 root 用户登录实例？](https://cloud.tencent.com/document/product/1207/44569#ubuntu-.E7.B3.BB.E7.BB.9F.E5.A6.82.E4.BD.95.E4.BD.BF.E7.94.A8-root-.E7.94.A8.E6.88.B7.E7.99.BB.E5.BD.95.E5.AE.9E.E4.BE.8B.EF.BC.9F)
- [设置 ssh 连接 timeout](https://www.tecmint.com/increase-ssh-connection-timeout/)

核心步骤如下:

```bash
# 登录服务器,创建 root 账户,设置密码,修改相关配置
$ sudo passwd root
>>> passwd: password updated successfully

# 修改 ssh 服务端配置,将 PermitRootLogin、PasswordAuthentication 置为 yes,之后进行保存
# 修改 ssh timeout 时间, 设置 ClientAliveInterval(单位秒) 和 ClientAliveCountMax, timeout = ClientAliveInterval * ClientAliveCountMax
$ sudo vi /etc/ssh/sshd_config 

# 重启 ssh
$ sudo service ssh restart
```

### 搭建 FTP 服务

参考:

- [Linux 云服务器搭建 FTP 服务](https://cloud.tencent.com/document/product/213/10912)
- [Cyberduck FTP客户端工具](https://cyberduck.io/)

核心步骤:

```bash
# 根据腾讯云文档修改安装、启动并且配置 vsftpd 服务,相关配置:
# 修改配置,并且注释 listen_ipv6=YES(即 ipv6 不生效)
anonymous_enable=NO
local_enable=YES
chroot_local_user=YES
chroot_list_enable=YES
chroot_list_file=/etc/vsftpd/chroot_list
listen=YES
# 添加配置
local_root=/home/xxx
allow_writeable_chroot=YES
pasv_enable=YES
pasv_address=xxx.xx.xxx.xx #请修改为您的 Linux 云服务器公网 IP
pasv_min_port=40000
pasv_max_port=45000


# 需要注意新建 linux 用户时,设置语义化的用户名
$ useradd xxx
$ passed xxx

# 很重要的一步,腾讯云文档有误.在 home 目录下,需要以 /home/[用户名] 的形式创建文件夹,并且赋予权限
# 否则, 客户端 ftp 连接时会出现问题
$ mkdir /xxx
$ chmod -R 777 /home/xxx

# 最后开放 FTP 相关的防火墙设置,轻量服务器开通防火墙,CVM 设置相关安全组

# 如果在上传文件时,出现 550 permission denied 错误,可以尝试设置:
write_enable=YES
anon_mkdir_write_enable=YES
```

### coscli

[coscli](https://cloud.tencent.com/document/product/436/63143) 是腾讯云对象存储的客户端命令行工具。基于此，我们可以方便地在本地对对象存储进行操作，通常我们可以利用其发起应用的发布流程。

:::info
注意在 macos 内，将可执行脚本直接放到 `/usr/local/bin` 目录下(Linux 在 `/usr/bin` 目录下)，就能够直接全局调用
:::

下面对其常用操作进行记录，方便随时查阅

```bash
# 将本地图片上传到 cos 指定 bucket 内，调换顺序则可以直接从 cos 上下载文件到本地
coscli cp ./xxx.png cos://xxx-1300606192/showcase/xxx.png

# 注意需要为 bucket name 加上 cos:// 前缀来查看具体内容
coscli ls
coscli cos://xxx-1300606192
```

在使用 coscli 时，需要注意：

- 在上传或者拉取桶内的文件时，需要先执行 `coscli config show` 来查看当前桶是否已经写入本地配置，如果没有，则执行 `coscli config add -b [bucket name] -r [region]` 进行添加  


## 通用技能

### 启停服务

- `service --status-all` 查看所有服务
- `service [server-name] stop` 停止服务
- `service [server-name] start` 启动服务
- `service [server-name] restart` 重启服务
- `service [server-name] status` 查看服务状态

### TOP 查看当前系统运行情况

`top` 查看当前系统进程信息（但是在容器内，该命令并不准确，需要去文件内查看真是内存使用），也可以通过 `ps -aux` 来查看

- 按照内存占用排序：按下 `M`
- 按照 CPU 占用排序，按下 `P`

### 解决端口占用

查看端口占用情况

`ps` 查看系统内进程，可以看到 pid 信息

- `ps -e` 展示所有进程
- `ps -aux` 显示所有包含其他使用者的进程

`lsof` （list open files）列出当前系统打开文件的工具

- `lsof -i:3000` 查看 3000 端口占用情况

`netstat -tunlp` 用于显示 tcp，udp 的端口和进程等相关情况

- `t(tcp)` 展示 TCP 相关的选项
- `u(udp)` 展示 UDP 相关的选项
- `n` 拒绝显示别名，能显示数字则展示数字
- `l` 列出在 Listen 的服务状态
- `p` 显示相关链接的程序名

上述命令结合 `grep` 来查找指定信息，之后执行 `kill -9 [pid]` 来关闭指定 pid 的进程


### 文件操作

1. `pwd` 打印当前文件路径
2. `find -name [name]` 全局搜索
3. `whereis [filename]` 查看路径
4. `mkdir [filename]` 在当前目录下创建一个文件夹
5. `rm -rf [filepath]` 删除指定目录下的文件夹及其目录下的所有文件
6. `rm -f [file]` 删除文件
7. `cp [filename] [path]` 复制指定文件到指定目录
8. `mv filename newfilename` 重命名文件或者文件目录


<HighlightWithText>通过 zip 解/压文件</HighlightWithText>

- `zip -r xxx.zip xxx` 压缩指定文件夹为 .zip 文件
- `unzip xxx.zip` 直接解压指定文件，输出到当前目录
- `zip xxx.zip 1.txt 2.txt` 将 1.txt 和 2.txt 压缩为 xxx.zip
- `unzip xxx.zip -d /home` 将 xxx.zip 解压到 `/home` 目录下

<HighlightWithText>通过 tar 解/压文件</HighlightWithText>

- `tar -zcvf target.tar.gz [package files]` 进行压缩
- `tar -zxvf target.tar.gz` 解压文件

<!-- fix Highlights -->

#### 可执行权限

系统内，读、写和可执行权限对应的数字如下所示：

- `r(read)` = 4
- `w(write)` = 2
- `x(execute)` = 1
- no permissions = 0

权限的设置实际上就是上面的数字求和，比如：

- 7(4 + 2 + 1) 读、写、可执行

为文件设置最高权限，在文件的上级目录内执行 `sudo chmod -R 777 [targetFileName]`， `-R` 表示递归（recursive），即所有子文件同步设置权限

#### 目录信息

`ls -al` 查看目录下文件的详细信息

`du -sh *` 查看每个目录的大小


## 常用工具

### bash 的 url 工具 -- curl

执行 `curl https://www.xxx.com` 就可以发出一个 GET 请求，服务器返回值会在命令行内输出

- `-A` 表示请求头内 `user-agent`
- `-H` 表示请求头
- `-b` 用来像服务器发送 cookie，比如 `curl -b 'key=value' https://www.xxx.com`
- `-d` 用来表示 post 请求的 body 内容
- `-G` 用来指定 GET 方法，比如 `curl -G -d 'key1=v1' -d 'k2=v2' https://www.xxx.com`，表示发送一个 GET 请求，`https://www.xxx.com?key1=v1&key2=v2`，如果不指定 -G，则会发送一个 POST 请求


### VIM

命令模式:

删除
- `dd` 快速删除当前行
- `ndd` 比如 `3dd` 开始删除当前三行内容

复制
- `yy` 快速复制当前行
- `nyy` 快速复制当前 n 行内容
- `p` 粘贴内容
- `ggdG` 删除所有内容，`gg` 光标置于首行，`d` 删除，`G` 光标置于文件末尾行

回退
- `u` 回退内容

搜索
- 通过 `/` 进入搜索模式，通过 `n/N` 来跳转到下一个/上一个

### wget

`wget --version` 查看是否安装 wget

wget 是一个从网络上自动下载文件的自由工具，支持通过 HTTP、HTTPS、FTP 三个最常见的 TCP/IP 协议 下载，并可以使用 HTTP 代理

ubuntu 通常内置 `yum` 和 `apt-get`

- `apt-get update`
- `apt-get install xxx`

### 软硬链接

在上文中，我们通过软链接来做了一个指向绝对路径的“快捷方式”，这里我们简单区分一下软/硬链接的概念：

- 硬链接：其 `inode`(可以理解为指针) 都指向同一个文件在内存中的区块，这意味着改变链接文件，另一个文件也会同步改变，`ln file hard`
- 软链接：保存了其代表文件的绝对路径，在内存上有自己独立的区块，访问时会替换自身路径

### 格式化时间

`time=$(date "+%Y%m%d-%H%M%S")` 格式化当前时间，注意 `date` 后面加空格



