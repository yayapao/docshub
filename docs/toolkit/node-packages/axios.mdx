---
id: axios
title: ''
sidebar_label: axios
---

import { DocsHeader } from '/src/components/Layout/DocsHeader'
import { HighlightWithText } from '/src/components/Highlights'

<DocsHeader
  title="Axios"
  description="Promise based HTTP client for the browser and node.js!"
  github="https://github.com/axios/axios"
  npm="https://www.npmjs.com/package/axios"
  tags={['promise', 'XMLHttpRequests']}
  links={[
    { label: 'Getting Started', link: 'https://axios-http.com/docs/intro' },
  ]}
/>

<!-- -->

我们将实现以下特性：

**取消重复请求** 核心思想利用`set`数据结构，维护一个 pending set，里面存放 key(由 `method` + `path` + `query` + `body` 组成)和 value(取消改请求的 cacel 方法)。注意，`cancel` 是浏览器的行为，服务器仍会收到相关请求，只是浏览器不会继续对 canceled 的请求进行处理。

**取消 body size 限制** 用来解决请求包体过大，导致发出请求失败的问题

```js
import axios from 'axios'
import { message } from 'ant-design-vue'

// 声明一个 Map 用于存储每个请求的标识 和 取消函数
const pending = new Map()

// 通过工厂方法创建 canceltoken，用于取消用户请求
let CancelToken = axios.CancelToken
let source = CancelToken.source()

// axios 实例
let service = axios.create({
  baseURL: '/api',
  timeout: 60000,
  headers: {},
  withCredentials: true,
})

const addPending = (config) => {
  const url = [
    config.method,
    config.url,
    JSON.stringify(config.params),
    JSON.stringify(config.data),
  ].join('&')
  config.cancelToken =
    config.cancelToken ||
    new axios.CancelToken((cancel) => {
      if (!pending.has(url)) {
        // 如果 pending 中不存在当前请求，则添加进去
        pending.set(url, cancel)
      }
    })
}

const removePending = (config) => {
  const url = [
    config.method,
    config.url,
    JSON.stringify(config.params),
    JSON.stringify(config.data),
  ].join('&')
  if (pending.has(url)) {
    // 如果在 pending 中存在当前请求标识，需要取消当前请求，并且移除
    const cancel = pending.get(url)
    cancel(url)
    pending.delete(url)
  }
}

export const clearPending = () => {
  for (const [url, cancel] of pending) {
    cancel(url)
  }
  pending.clear()
}

// 设置请求拦截器
service.interceptors.request.use(
  (config) => {
    removePending(config) // 在请求开始前，对之前的请求做检查取消操作
    addPending(config) // 将当前请求添加到 pending 中
    // fix: Error: Request body larger than maxBodyLength limit
    config['maxContentLength'] = Infinity
    config['maxBodyLength'] = Infinity
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 设置响应拦截器
service.interceptors.response.use(
  (response) => {
    removePending(response.config) // 在请求结束后，移除本次请求
    return response
  },
  (error) => {
    if (axios.isCancel(error)) {
      // 再次尝试 cancel
      console.error(error.message)
    }
    return Promise.reject(error)
  }
)

/**
 * config.params 用来接受查询参数
 */
async function get(url, config = {}) {
  const response = await service.get(url, config)
  // 返回服务器传值
  return response.data
}

/**
 * params 用来接收查询参数
 */
async function post(url, params, config = {}) {
  const response = await service.post(url, params, config)
  // 返回服务器传值
  return response.data
}

export { get, post }
```
